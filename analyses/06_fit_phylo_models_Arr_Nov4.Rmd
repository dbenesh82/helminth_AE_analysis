---
title: "Determinants of helminth activation energy (Arrhenius)"
author: "Dan Benesh"
date: "November 15, 2019"
output: github_document
---

The purpose of this notebook is to explore and model the activation energies for helminth development. I specifically use activation energies fit with the **Arrhenius** model.

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(ape)
library(ggtree)
library(RColorBrewer)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
options(stringsAsFactors = FALSE)
theme_set(new = theme_bw())
```

```{r importdata}
ae <- read.csv(file = "../data/SS_Arr_FitResults_1910.csv", header = TRUE)
dat <- read.csv(file = "../data/Helminth data plant + animal global temps Sept8 2019.csv", header = TRUE)
tree <- read.tree(file = "../data/full_tree_time_calib.nex")
```

```{r}
dat <- select(dat, tpc_num, Genus, Species, Family, Order, Class, Phylum, 
              sample_size_all_temps, num_temps, trait_type, same_experiment, trait_detail,
              latitude, altitude_m, author_latitude, habitat, habitat.cat.2,
              distribution, distrib.cat.1,
              mean_ann_temp = bio1, max_month_temp = bio5, min_month_temp = bio6,
              Stage.in.out.of.host, host.type, hosts..in.order., p_size = parasite.size..units.,
              experiment = same_experiment, trait_detail, independent, authors, year)
```

# Get data organized

First, I get the data organized for modelling. From the table of curve fits, I take the **Arrhenius** activation energies and add them to the table including the predictors.

```{r}
dat <- left_join(dat, ae, by = 'tpc_num') # join by temperature preference curve identifier
dat <- filter(dat, !is.na(E_Arr)) # remove those without Act E
```
```{r}
# sapply(dat, function(x){sum(is.na(x))})
```

How many AE estimates are there?

```{r}
length( na.omit(dat$E_Arr) )
```

How many unique species are in the data?

```{r}
dat <- mutate(dat, binomial = paste0(Genus, "_", Species))
length(unique(dat$binomial))
```

So there are a fair number of species with multiple curves.

```{r}
# dat$binomial[!dat$binomial %in% tree$tip.label]
```
```{r}
dat$binomial[which(dat$binomial == "Protostrongylus _stilesi/rushi (spp.)")] <- "Protostrongylus_stilesi" # this species has sequences avail and is in 'mega tree'
dat$binomial[which(dat$binomial == "Dochmoides_stenocephala")] <- "Uncinaria_stenocephala" # synonym
dat$binomial[which(dat$binomial == "Dioctophyma_renale")] <- "Dioctophyme_renale" # misspelling
dat$binomial[which(dat$binomial == "Ostertagia_circumcincta")] <- "Teladorsagia_circumcincta" # this species has sequences avail and is in 'mega tree'
```
```{r}
# dat$binomial[!dat$binomial %in% tree$tip.label]
```
```{r}
spp_not_in_dat <- tree$tip.label[!tree$tip.label %in% dat$binomial]
# spp_not_in_dat
```
```{r}
tree_red <- drop.tip(tree, spp_not_in_dat)
```

### Look at the response - activation energy

What is the distribution of activation energies?

```{r}
qplot(dat$E_Arr)
```

The median activation energy was `r round(median(dat$E_Arr), 2)`.

```{r}
# median(dat$E_Arr)
```

How confident are we in each activation energy estimate? For this, we look at the distribution of standard error estimates for the activation energies. Most are small, but there is an outlier.

```{r}
ggplot(dat, aes(x = stderr_arr)) +
  geom_histogram()
```

All else equal, we should have more confidence in curves fit with a larger number of temperatures. To reflect this, standard error should decrease with sample size (i.e. number of temperatures). But this is not obvious when we plot standard error as a function of temperatures.

```{r}
ggplot(dat, aes(x = num_temps, y = stderr_arr)) +
  geom_point(alpha = 0.5) + geom_smooth() 
```

When we zoom in to exclude the outlier, there is still not a clear relationship between standard error and the number of temperatures. However, the largest standard errors are observed with the lowest sample sizes (left-hand part of plot), which is reassuring.

```{r}
ggplot(dat, aes(x = num_temps, y = stderr_arr)) +
  geom_point(alpha = 0.5) + 
  geom_smooth() +
  # geom_smooth(method = 'lm', se = F, linetype = 'dotted') +
  coord_cartesian(ylim = c(0, 0.5))
```

With less precision (higher standard errors), we would expect a broader distribution of activation energy estimates. Let's look at the distribution of activation energies split by whether standard error was high or low (above or below the median SE). Surprisingly, the estimates with lower standard errors have a broader distribution, opposite to expectations.

```{r}
dat <- mutate(dat, se_cat = if_else(stderr_arr > median(stderr_arr, na.rm = T), "high standard error", "low standard error"))
```
```{r}
ggplot(dat, aes(x = E_Arr)) + 
  geom_histogram() +
  facet_wrap(~se_cat, nrow = 2)
```

The median of the distribution also seems to vary with standard error; high standard error is associated with higher activation energy.

```{r}
group_by(dat, se_cat)%>%
  summarize(median_AE = median(E_Arr))
```

Thus, when we weight the data points by the standard error of the activation energies, it should shift the overall mean down.

## Same experiment, different metrics

In some cases, multiple TPCs were fit to data from the same experiment. For example, one curve fit for minimum developmental time and one for maximum developmental time. These are not independent because the same individual parasites contribute to both metrics. In these cases AE measurements should be highly correlated.

```{r}
dat <- mutate(dat, same_exp = if_else(independent == "1/2 trait detail" | independent == "1/3 trait detail", "yes", "no")) # hopefully, I understood this correctly
```
```{r}
# simplify response metric
dat <- mutate(dat, trait_detail2 = if_else(trait_detail %in% c("I averaged min & max", "I averaged min and max", "I averaged min and max of range"), "midpoint",
                                           if_else(trait_detail %in% c("50% (I sumed 2 stages)", "50%"), "50% developed",
                                                   if_else(trait_detail %in% c("mean", "mean (I summed 2 stages)"), "mean", 
                                                           if_else(trait_detail == "min ", "min", trait_detail)))))%>%
  mutate(trait_detail2 = factor(trait_detail2, levels = c("min", "50% developed", "midpoint", "mean", "max", "not specified")))%>%
  mutate(trait_detail3 = if_else(trait_detail2 %in% c("midpoint", "mean", "50% developed"), "mid", as.character(trait_detail2)))%>%
  mutate(citation = paste(authors, year))
```

Let's make a plot for the species with multiple activation energy measurements. When we do this, we see that AE estimates from the same experiment tend to cluster as expected.

```{r}
mm <- group_by(dat, binomial)%>%
  summarize(AE = median(E_Arr, na.rm = T), n = n())%>%
  arrange(AE)
sp_mm <- mm$binomial[which(mm$n>1)] # species with multiple measurements
```
```{r}
ggplot(filter(dat, binomial %in% sp_mm)%>%
         mutate(bi_o = factor(binomial, levels = sp_mm)),
       aes(x = bi_o, y = E_Arr, color = same_exp)) +
  geom_point(alpha = 0.5) +
  coord_flip() +
  labs(x = "Species", y = "Activation energy (Arrhenius)", color = "Same experiment?")
```

This indicates how these values are not independent. Since this is an issue that only affects a few species, I'm not inclined to devise an `experiment` random effect that accounts for this pseudoreplication statistically. Rather, I would probably only take a single AE per experiment. But which one?

We can zoom in on just these cases where there are multiple measurements from the same experiment. If the metric was minimum development time, activation energy is higher; if it was maximum development time, activation energy is lower. This demonstrates that the developmental metric impacts activation energy estimates. 

```{r}
ggplot(filter(dat, binomial %in% sp_mm, same_exp == 'yes')%>%
         mutate(bi_o = factor(binomial, levels = sp_mm)),
       aes(x = bi_o, y = E_Arr, color = trait_detail2)) +
  geom_point(alpha = 1) +
  coord_flip() +
  labs(x = "Species", y = "Activation energy (Arrhenius)", color = "Devo metric")
```

This also highlights the concerns Peter has raised about *apparent* developmental rates, in that development is not measured for all viable worms (ones that die before maturing are excluded). We can examine whether activation energy varies systematically with developmental metric. It does, but not conspicuously or in the same way as within an experiment. For example, the 'max' group is higher than the 'min' group overall, while this was reversed within experiments.

```{r}
ggplot(dat, aes(y = E_Arr, x = trait_detail3)) + 
  geom_boxplot(outlier.color = NA) +
  geom_point(position = position_jitter(width = 0.2, height = 0), alpha = 0.5) +
  coord_flip() +
  labs(y = "Activation energy (Arrhenius)") +
  theme(axis.title.y = element_blank())
```

Overall, most activation energies were based on mean developmental rates. Thus, in the few cases where multiple TPCs were fit to data from the same experiment, but different metrics, I would only retain the activation energy for mean devo time.

```{r}
table(dat$trait_detail2)
```

In some cases, the source of repeated measures on a single species was recorded. For example, if the temperature dependence of multiple parasite populations or life stages was studied. We can also plot these variables in a similar to above. I do not notice an obvious trend. 

```{r}
# make variable for other sources of variability within species/studies
dat <- mutate(dat, ind2 = if_else(independent == "1/2 development stage" | independent == "1/3 development stage" | independent == "2/2 development stage", "life stages",
                                  if_else(independent == "1/2 trait detail" | independent == "1/3 trait detail", "metrics", 
                                          if_else(independent == "1/2 host" | independent == "1/6 host", "hosts", 
                                                  if_else(independent == "1/3 populations", "populations", "other"))))) # hopefully, I understood this correctly
```
```{r}
ggplot(filter(dat, binomial %in% sp_mm)%>%
         mutate(bi_o = factor(binomial, levels = sp_mm)),
       aes(x = bi_o, y = E_Arr, color = ind2)) +
  geom_point(alpha = 0.5) +
  coord_flip() +
  labs(x = "Species", y = "Activation energy (Arrhenius)", color = "Different:")
```

After removing AEs from the same experiment, how many AE estimates per species?

```{r}
dat <- filter(dat, !(same_exp == "yes" & trait_detail3 != 'mid'))
```
```{r}
filter(dat, !is.na(binomial), !is.na(E_Arr))%>%
  group_by(binomial)%>%
  summarize(n = n())%>%
  summary()
```

Usually just one, but up to 8. For visualizing, I'll randomly take one AE per species. 

```{r}
dat_1per_sp <- dat%>%group_by(binomial)%>%sample_n(1)
```

This reduces the data from n = `r length(dat$binomial)` to n = `r length(dat_1per_sp$binomial)`.

Make a plot of the distribution of activation energy across the tree.

```{r}
tree_df <- fortify(tree_red)
tree_df <- left_join(tree_df, dat_1per_sp, by = c("label" = "binomial"))
```
```{r}
p <- ggtree(tree_df)
facet_plot(p, panel = 'Activation Energy', 
           data = select(ungroup(dat_1per_sp), id = binomial, val = E_Arr),
           geom = geom_segment, aes(x=0, xend = val, y = y, yend = y))

```

The bars on the right are the estimated activation energies. Maybe some clades at the top (nematodes) have higher values than those at the bottom (flatworms), but it is not conspicuous. I don't think that is super surprising, because I assume AE is a parameter that is subject to a fair amount of measurement error.

# Phylogenetic mixed models

I'll fit phylogenetic mixed models (see [here](https://onlinelibrary.wiley.com/doi/full/10.1111/j.1420-9101.2009.01915.x) for an overview of these models) using the `MCMCglmm` library. These are not simple models, but the Bayesian `MCMCglmm` package does allow us to fit both within- and between-species effects in the same model. It also allows us to weight the activation energies by their standard errors.

Before diving into the models, though, let's outline a model-building strategy. First, I fit a 'base' model with the tangential variables. Here, I would include phylogeny and within-species variation. From the outset, I weight each data point by the standard error of activation energy. This weight was incorporated into the model as suggested [here](https://ourcodingclub.github.io/2018/01/22/mcmcglmm.html) and in the `MCMCglmm` course notes. Second, I add biologically interesting variables to this base model. Here, I would categorize interesting variables into two groups: (1) characteristics of the external environment (like latitude, aquatic vs terrestrial, etc.) and (2) characteristics of the parasite (e.g. in or out of host, stage in the life cycle, etc.). With this as a plan, let's get modelling.

### Within-species effect

First, I create a null model that includes a parasite species random effect, but not a phylogenetic effect. Throughout, data points are weighted by their standard error. 

```{r}
library(MCMCglmm)
```
```{r}
prior1<-list(G=list(G1=list(V=1,nu=0.02), # uninformative prior for within species effect
                     G2=list(V=1,fix=1)), # btw observation variance due to measurement errror/SE of curve fit - fixed!
              R=list(V=1,nu=0.02)) 
```

```{r}
mod0 <- MCMCglmm(E_Arr ~ 1, 
                    random = ~ binomial + idh(stderr_arr):units, # w/in spp effx
                    data = dat, prior = prior1,
                    nitt=23000, thin = 10,
                    family = "gaussian", pr=F, verbose = F)
```
```{r}
# summary(mod0)
```

After fitting an MCMC model, a first quality check is looking at chain mixing. Essentially, we want the chain to bounce back and forth randomly - it shouldn't get stuck at particular parameter estimates.

```{r}
plot(mod0$VCV)
```

The within-species effect, `binomial`, mixes well and is non-zero, suggesting that multiple AE measurements on the same species tend to be similar. The variance component for `std-error` is fixed at 1, such that the weights assigned do not change as the posterior distribution is sampled by the Markov chain. 

The model intercept (the average activation energy) is about 0.66

```{r}
summary(mod0)
```

Here's the proportion of variation attributable to the within-species effect. 

```{r}
phy_h2 <- mod0$VCV[,'binomial']/(mod0$VCV[,'binomial'] + mod0$VCV[,'units'])
median(phy_h2)
```

It is high. On the one hand this makes sense, as many species only had a single measurement (and hence no residual value after accounting for a 'species effect'). Here's an attempt to visualize the variation in activation energy estimates for the species that had multiple measurements. The species are ordered by their median activation energy. One can see that some species tend to have very similar measurements, while for other species, there is a fair amount of spread in the estimated activation energies.

```{r}
mm <- group_by(dat, binomial)%>%
  summarize(AE = median(E_Arr, na.rm = T), n = n())%>%
  arrange(AE)
sp_mm <- mm$binomial[which(mm$n>1)] # species with multiple measurements
```
```{r}
ggplot(filter(dat, binomial %in% sp_mm)%>%
         mutate(bi_o = factor(binomial, levels = sp_mm)),
       aes(x = bi_o, y = E_Arr)) +
  geom_point(alpha = 0.5) +
  coord_flip() +
  labs(x = "Species", y = "Activation energy (Arrhenius)")
```


### Phylogenetic effect

Now, let's add phylogenetic effects to this mixed model. To do this, we create the phylogenetic covariance matrix and then include this as a random effect.

```{r}
tree_red2 <- makeNodeLabel(tree_red) # standardize node labels
Ainv <- inverseA(tree_red2)$Ainv # make inv of phy cov matrix

dat$tree_tips <- dat$binomial
```
```{r}
prior2<-list(G=list(G1=list(V=1,nu=0.02),
                    G2=list(V=1,nu=0.02),
                    G3=list(V=1,fix=1)), # btw observation variance due to measurement errror/SE of curve fit
              R=list(V=1,nu=0.02)) # uninformative prior for within species effect
```

For this model, the chain needs to be run for longer to get reasonable mixing, partly because the two random effects are related. If the model estimates higher values for the within-species variance component, it estimates less for the phylogenetic component, and vice versa. 

```{r}
mod1 <- MCMCglmm(E_Arr ~ 1, 
                 random = ~ binomial + tree_tips + idh(stderr_arr):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=63000, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```

After fitting, we can again plot the chains. They look good. The within-species effect (`binomial`) is smaller than the phylogenetic effect (`tree_tips`). 

```{r}
plot(mod1$VCV)
```

These results suggest that phylogenetically related species tend to have similar AEs, and when a species is measured multiple times, the estimated AEs are similar, though they are not far more similar than what they are expected to be based on phylogeny (i.e. the within-species effect does not explain much additional variation beyond phylogeny).

```{r}
phy_h2 <- mod1$VCV[,'tree_tips']/(mod1$VCV[,'tree_tips'] + mod1$VCV[,'binomial'] + mod1$VCV[,'units'])
# round(median(phy_h2), 2) * 100
```

The phylogenetic effect is strong. It explained `r round(median(phy_h2), 2) * 100`% of the variation in AE.

```{r}
phy_h2 <- mod1$VCV[,'binomial']/(mod1$VCV[,'tree_tips'] + mod1$VCV[,'binomial'] + mod1$VCV[,'units'])
# round(median(phy_h2), 2) * 100
```

By contrast, the 'species' effect explained `r round(median(phy_h2), 2) * 100`% of the variation.

Here's a plot splitting AE by parasite order. It does look like some clades tend to have higher or lower AEs.

```{r}
ord_A <- group_by(dat, Order)%>%
  summarize(AE = median(E_Arr, na.rm=T))%>%
  arrange(AE)

ggplot(mutate(dat, ord_A = factor(Order, levels = ord_A$Order)),
       aes(x = ord_A, y = E_Arr, color = Phylum)) + 
  geom_boxplot(outlier.color = NA) +
  geom_point(alpha = 0.5, position = position_jitter(width = 0.2), aes(size = 1/stderr_arr)) + 
  coord_flip() +
  theme(axis.title.y = element_blank()) +
  labs(size = "Weight - 1/SE")
rm(ord_A)
```

#### Developmental metric

As seen above, the chosen metric of development can affect activation energy estimates, at least within experiments. This was less clear across experiments. To check this effect, I added a fixed factor to the model that distinguishes between activation estimates based on mean, min, or unspecific developmental times.

```{r}
mod1.1 <- MCMCglmm(E_Arr ~ trait_detail3, 
                 random = ~ binomial + tree_tips + idh(stderr_arr):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=63000, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```

These differences were rather minimal (non-significant p-values). Moreover, the contrast between mean and min metrics was negative (min with lower AE than mean), which was opposite to that seen within experiments. 
```{r}
summary(mod1.1)
```

Thus, it is not clear how valuable this term is in the model. It does not "correct" activation energies in the direction we would expect. Therefore, I have not included it in further analyses.

### Environmental variables

Now, we move onto environmental variables of interest, though it is important to keep phylogenetic effects in mind during this modeling exercies. Essentially, any explanatory variable that is phylogenetically structured will "compete" with the phylogenetic random effect to explain variation in AE. 

I have tried to find a series of logical steps to testing environmental correlates of helminth AE. First and foremost, we expect AE to be related to environmental temperature, so I start with temperature variables.

#### Mean temperature

There are three temperature measurements in the data: mean, max, and min for the location. I would expect the three temp variables to be tightly correlated, so let's start by just adding the mean to the model. Note that I have centered the continuous variables around their median, such that the model parameters are estimated at e.g. the data's median annual temperature.

```{r}
dat <- mutate(dat, mean_ann_temp_cen = mean_ann_temp - median(mean_ann_temp),
              max_month_temp_cen = max_month_temp - median(max_month_temp),
              min_month_temp_cen = min_month_temp - median(min_month_temp))
```


```{r}
mod3 <- MCMCglmm(E_Arr ~ mean_ann_temp_cen, 
                 random = ~ binomial + tree_tips + idh(stderr_arr):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=63000, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```

The effect of mean locale temperature is negative and significant.

```{r}
summary(mod3)
```

For species living at lower temperatures, development speeds up more as temperature increases. It also does not look like this depends on whether an exact study location was given.

```{r}
dat <- mutate(dat, sample_loc_avail = if_else(author_latitude == ".", 'yes, exact', 'no, author loc')) # author location?
```
```{r}
ggplot(dat, aes(x = mean_ann_temp, y = E_Arr, color = sample_loc_avail)) +
  geom_point(alpha = 0.5, aes(size = 1/stderr_arr)) +
  labs(color = "exact location?") +
  geom_smooth(method = lm, se = F) 
```

#### Temperature variation

A mean temperature does not indicate the temperature range a parasite is exposed to. Thus, as the next modelling step, we'll include location min and max temps. None of these terms are significant, though the model DIC decreases, suggesting together they explain some variation.

```{r}
mod4 <- MCMCglmm(E_Arr ~ mean_ann_temp_cen + max_month_temp_cen + min_month_temp_cen, 
                 random = ~ binomial + tree_tips + idh(stderr_arr):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=63000, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```
```{r}
summary(mod4)
```

Interestingly, the parameter estimates for max and min temps are positive, which is opposite to the trend seen with mean temp. But when we plot AE as a function of max and min, we see a negative relationship just like for mean temp: low temps, high AE.

```{r}
ggplot(dat, aes(x = max_month_temp, y = E_Arr, color = sample_loc_avail)) +
  geom_point(alpha = 0.5, aes(size = 1/stderr_arr )) +
  labs(color = "exact location?", size = "Weight") +
  geom_smooth(method = lm, se = F)
```

```{r}
ggplot(dat, aes(x = min_month_temp, y = E_Arr, color = sample_loc_avail)) +
  geom_point(alpha = 0.5, aes(size = 1/stderr_arr )) +
  labs(color = "exact location?", size = "Weight") +
  geom_smooth(method = lm, se = F)
```

This is suggestive that, once controlling for mean temp, activation energies increase with higher max and min temps. Let's see if we can uncover this pattern in the data. We'll take the residuals from the previous model, which just included mean temperature, and plot them again max and min temp.

```{r}
preds <- predict(mod3) # predicted values with just mean temp
```
```{r}
ggplot(dat, aes(x = max_month_temp, y = preds - E_Arr, color = sample_loc_avail)) +
  geom_point(alpha = 0.5, aes(size = 1/stderr_arr )) +
  labs(color = "exact location?", size = "Weight", y = "Residual, mean temp only") +
  geom_smooth(method = lm, se = F) 
```
```{r}
ggplot(dat, aes(x = min_month_temp, y = preds - E_Arr, color = sample_loc_avail)) +
  geom_point(alpha = 0.5, aes(size = 1/stderr_arr )) +
  labs(color = "exact location?", size = "Weight", y = "Residual, mean temp only") +
  geom_smooth(method = lm, se = F) 
```

We uncover the positive relationships, but they are clearly weak. Thus, we are in a situation when one metric (DIC) suggests adding `max` and `min` temps improve the model, while other metrics, like p-values and plots do not indicate strong relationships. In cases like this, we need to decide if there is a good biological reason to include extreme temps, even if their effects are ambiguous. On the one hand, we could expect that temperature variability affects activation energy. On the other hand, a lower min temperature might not matter much if parasites do not develop below a certain threshold that is unlinked to the minimum temperature. Also, if temperature variability is what drives activation energy, then we would expect the parameter estimates for min and max to go in opposite directions, i.e. larger temperature extremes are associated with higher (or lower) AE values. Since (i) these results are ambiguous, (ii) they are confounded with mean temperature, and (iii) we test several other proxies of seasonality/temperature variability, my preference is to drop min and max temp from the model.

#### Seasonality

Variation in temperature is one component of seasonality, but not the only one. Season length, photoperiod, rainfall, etc. may all vary with seasons and perhaps impact the thermal-dependence of parasite development. The dataset contains two variables that might capture seasonality: latitude and distribution. Distribution zones were defined as 'tropics', 'temperate', 'polar', etc., which means this variable overlaps substantially with latitude. Consequently, I examine these two variables in parallel (i.e. I won't put both in the same model). 

##### Latitude

Let's look at latitude first, as it is a single continuous variable while distribution is multiple categories. In some cases, a study gave a detailed location, so our data contains exact latitudes. In other cases, no site was given and the author's location was taken as a rough proxy of the study's location. Most records were from the Northern hemisphere, but a few were from the Southern hemisphere. Thus, I took the absolute value of latitude, essentially the distance from the equator.

```{r}
dat <- mutate(dat, lat_abs = if_else(latitude == ".", abs(as.integer(author_latitude)), abs(as.integer(latitude))))
```

```{r}
mod5 <- MCMCglmm(E_Arr ~ mean_ann_temp_cen + lat_abs, 
                 random = ~ binomial + tree_tips + idh(stderr_arr):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=63000, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```

There is a marginal relationship between AE and latitude.

```{r}
summary(mod5)
```

Surprisingly, the parameter estimate for latitude is negative, but when we plot it, we see that activation energies tend to increase with latitude.

```{r}
ggplot(dat, aes(x = lat_abs, y = E_Arr, color = sample_loc_avail)) + 
  geom_point(alpha = 0.5, aes(size = 1/stderr_arr )) +
  geom_smooth(method = lm, se = F) +
  labs(x = 'latitude', color = "exact location?",size = "Weight") 
```

This suggests that, like for `min` and `max` temperature, correlations among variables (here between mean temp and latitude) might cause counterintuitive or spurious results. When we remove the effect of mean temperature on activation energy (i.e. we take the residuals of the model with just mean temp), and then plot the residual variation as a function of latitude, we see essentially no relationship between latitude and activation energy.

```{r}
ggplot(dat, aes(x = lat_abs, y = preds - E_Arr, color = sample_loc_avail)) + 
  geom_point(alpha = 0.5, aes(size = 1/stderr_arr )) +
  geom_smooth(method = lm, se = F) +
  labs(x = 'latitude', color = "exact location?", y = "Residuals, mean temp only model", size = "Weight") 
```

Thus, even though the term was significant, the effect of latitude is hard to interpret and not an obvious improvement to the model. Let's look at the next variable, which is related to latitude.

##### Climate zones

Our latitude variable is not a perfect representation of a parasite's 'ancestral' habitat. Many species in the data are associated with people or livestock and have thus been moved all around the world. This is reflected in the distribution zone variable: it contains a category for parasites with a broad distribution.

```{r}
# filter(dat, distrib.cat.1 == '6')%>% # to understand dummy coding of distribution var
#   select(distribution,distrib.cat.1)

dat <- mutate(dat, dist_zone = if_else(distrib.cat.1 == 2, '(sub)polar', 
                                       if_else(distrib.cat.1 == 3, 'temperate', 
                                               if_else(distrib.cat.1 == 4, 'subtropical',
                                                       if_else(distrib.cat.1 == 5, 'tropical', 
                                                               if_else(distrib.cat.1 == 6, 'global', 'NA'))))))%>%
  mutate(dist_zone = factor(dist_zone, levels = c('(sub)polar', 'temperate', 'subtropical', 'tropical','global')))
dat$dist_zone[which(dat$dist_zone == "NA")] <- NA
```

However, the distribution categories are still tightly linked to latitude.

```{r}
ggplot(dat, aes( x = dist_zone, y = lat_abs)) +
  geom_boxplot(outlier.colour = NA) +
  geom_point(alpha = 0.5, position = position_jitter(width = 0.2)) +
  labs(x = NULL, y = 'Latitude')
```

Nonetheless, let's add this variable to the model instead of latitude.

```{r}
mod6 <- MCMCglmm(E_Arr ~ mean_ann_temp_cen + dist_zone, 
                 random = ~ binomial + tree_tips + idh(stderr_arr):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=63000, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```

Most of the contrasts among these categories are not significant.

```{r}
summary(mod6)
```

Consistent with the pattern for temperature and latitude, polar species tend to have higher AE. 

```{r}
ggplot(dat, aes( x = dist_zone, y = E_Arr)) +
  geom_boxplot(outlier.colour = NA) +
  geom_point(alpha = 0.5, position = position_jitter(width = 0.2), aes(size = 1/stderr_arr)) +
  labs(x = NULL, y = 'Activation energy', size = "Weight")
```

Latitude and distribution overlap and presumably explain the same variation in AE, but which explains it better? We can compare the models with latitude vs distribution zone using information criteria. Here is the progression of model fits thus far (low DIC, better model):

```{r}
print(paste0("DIC for model with phylogeny: ", round(mod1$DIC, 1)))
print(paste0("DIC for model with just mean temp: ", round(mod3$DIC, 1)))
print(paste0("DIC for model with latitude: ", round(mod5$DIC, 1)))
print(paste0("DIC for model with distribution zone: ", round(mod6$DIC, 1)))
```

According to this measure, the model with distribution is better than the one with latitude. One explanation for this, is that including distribution zone strengthens the estimated effect of mean annual temperature; it explains residual variation around the temp-AE relationship. 

```{r}
ggplot(dat, aes(x = mean_ann_temp, y = E_Arr, color = dist_zone)) + 
  geom_point(alpha = 0.5, aes(size = 1/stderr_arr)) + 
  geom_smooth(method = lm, se = F) +
  labs(x = 'Mean annual temperature', y = "Activation energy", color = "exact location?", size = "Weight") 
```

Thus, I'll retain distribution in the model as a proxy for seasonality, but I'll drop latitude.

#### Habitat - aquatic vs freshwater

As a final environmental variable, we can add parasite habitat: aquatic vs terrestrial. Water dampens temperature swings, such that seasonality is less pronounced in aquatic habitats compared to terrestrial ones. Thus, this variable might modify the effect of seasonality proxies like distribution zone.
(Note: for a couple TPCs, I filled in habitat and distribution data.)

```{r}
# make habitat variable easy to understand
dat <- mutate(dat, habitat_d2 = if_else(habitat.cat.2 == 1, 'freshwater', 
                                       if_else(habitat.cat.2 == 2, 'terrestrial', 
                                               if_else(habitat.cat.2 == 3, 'marine', 'NA'))))
dat$habitat_d2[which(dat$habitat_d == "NA")] <- NA

dat <- mutate(dat, habitat_d1 = if_else(habitat_d2 == 'terrestrial', 'terrestrial',
                                        if_else(habitat_d2 == 'freshwater' | habitat_d2 == 'marine', 'aquatic', 'NA')))
dat$habitat_d1[which(dat$habitat_d == "NA")] <- NA

# sum(is.na(dat$habitat_d))
```
```{r}
mod7 <- MCMCglmm(E_Arr ~ mean_ann_temp_cen + dist_zone + habitat_d1, 
                 random = ~ binomial + tree_tips + idh(stderr_arr):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=63000, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```

Adding habitat to the model improves DIC, but the parameter is not significant.

```{r}
summary(mod7)
```

Terrestrial species have higher AE on average than aquatic species (combines both freshwater and marine species). This plot also demonstrates how weights (standard errors) reduced the estimated effect of habitat. The raw difference in AE between habitats was about 0.11, but the model estimated it to be lower, 0.07.

```{r}
ggplot(filter(dat, !is.na(habitat_d1)),
       aes(x = habitat_d1, y = E_Arr)) +
  geom_boxplot() +
  geom_point(aes(size = 1/stderr_arr), position = position_jitter(width = 0.2), alpha = 0.3) +
  labs(size = "Weight")
```

We might expect the aquatic - terrestrial dichotomy to be particularly important in more seasonal locations. That is, there may be an interaction between our seasonality proxy (distribution) and habitat. Unfortunately, this cuts the data quite thin, as there are not many freshwater and terrestrial species in each distribution category.


```{r}
ggplot(filter(dat, !is.na(habitat_d1)),
       aes(x = habitat_d1, y = E_Arr)) +
  geom_boxplot() +
  geom_point(aes(size = 1/stderr_arr), position = position_jitter(width = 0.2), alpha = 0.3) +
  facet_wrap(~dist_zone) +
   labs(size = "Weight")
```
```{r}
# same plot, but with latitude
# ggplot(filter(dat, !is.na(habitat_d1)),
#        aes(x = lat_abs, y = E_Arr, color = habitat_d1)) +
#   geom_point(aes(size = 1/stderr_arr), position = position_jitter(width = 0.2), alpha = 0.3) +
#   geom_smooth(se = F, method = lm) +
#   labs(size = "Weight") 
```

When we add this interaction to the model, it is not an improvement.

```{r}
mod8 <- MCMCglmm(E_Arr ~ mean_ann_temp + dist_zone * habitat_d1, 
                 random = ~ binomial + tree_tips + idh(stderr_arr):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=63000, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```
```{r}
summary(mod8)
```

To summarize, AE tends to be higher with low mean locale temperatures. This happens at high latitudes, but this effect is not independent of temperature.

### Host-parasite characteristics

Now, we turn from the environment to variables describing the host-parasite interaction. I consider a few variables: (1) host type, (2) stage in or out of host, and (3) target host. Compared to the environmental variables, these variables are not as obviously confounded.

#### Plant vs animal parasite

A major dichotomy is between between plant and animal parasites. This might be relevant if plant and animal hosts have different activation energies or if they differ in how much they 'protect' parasites from temperature variation.

```{r}
dat <- mutate(dat, plant_anim = if_else(hosts..in.order. == 'plant', 'plant',
                                        if_else(!is.na(hosts..in.order.), 'animal', 'NA')))
dat$plant_anim[which(dat$plant_anim == "NA")] <- NA
```

```{r}
mod9 <- MCMCglmm(E_Arr ~ mean_ann_temp_cen + dist_zone + habitat_d1 + plant_anim, 
                 random = ~ binomial + tree_tips + idh(stderr_arr):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=63000, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```

Distinguishing plants and animals is not significant, though the model DIC goes down. Plant parasites tend to have lower AE than animal parasites. Also, I imagine this distinction is strongly conflated with phylogeny.

```{r}
summary(mod9)
```

Here's the plot comparing plant and animal parasites.

```{r}
ggplot(dat, aes(x = plant_anim, y = E_Arr)) +
  geom_boxplot(outlier.size = NULL, outlier.alpha = 0) +
  geom_point(aes(size = 1/stderr_arr), position = position_jitter(width = 0.2), alpha = 0.3) +
  labs(x = NULL, y = "Activation energy", size = "Weight")
```

#### Endotherm in life cycle

Besides the plant - animal distinction, parasites can be distinguished by whether or not they have an endotherm (a bird or mammal) in the life cycle. Since endotherm body temperatures are commonly higher than ambient temperatures, we might expect AE to differ between species with or without such a host in the life cycle.

```{r}
dat <- dat%>%mutate(endo_ecto = if_else(grepl(hosts..in.order., pattern = "mammal"), "endotherm in life cycle",
                                 if_else(grepl(hosts..in.order., pattern = "bird"), "endotherm in life cycle", "no endotherm in life cycle")))
```

This variable basically retains the previous plant-animal dichotomy, but it additionally splits animal parasites into two groups.

```{r}
table(dat$endo_ecto, dat$plant_anim)
```

We can thus combine these into a single variable to add to the model.
```{r}
dat <- dat%>%mutate(endo_ecto2 = if_else(plant_anim == "plant", "plant", endo_ecto))
```

```{r}
mod10 <- MCMCglmm(E_Arr ~ mean_ann_temp_cen + dist_zone + habitat_d1 + endo_ecto2, 
                 random = ~ binomial + tree_tips + idh(stderr_arr):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=63000, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```

Again, model DIC decreased, but the term contrasting animal parasites with and without endotherms in the cycle was not significant (0.1). It suggests species without endotherms have higher AEs.

```{r}
summary(mod10)
```

However, this trend is not visible in the raw data, suggesting it is contingent on the covariates in the data.

```{r}
ggplot(dat, aes(x = endo_ecto2, y = E_Arr)) +
  geom_boxplot(outlier.size = NULL, outlier.alpha = 0) +
  geom_point(aes(size = 1/stderr_arr), position = position_jitter(width = 0.2), alpha = 0.3) +
  labs(x = NULL, y = "Activation energy", size = "Weight")
```

When we plot these groups as a function of mean annual temperature, we then see that, at a given temperature, species exclusively infecting ectotherms have higher AE. This pattern is not strong, but it is consistent with the idea that environmental stability lowers AE (endotherms provide a stable temperature for helminths).

```{r}
ggplot(dat, aes(x = mean_ann_temp, color = endo_ecto2, y = E_Arr)) +
  geom_point(aes(size = 1/stderr_arr), alpha = 0.5) +
  geom_smooth(method = lm, se = F) +
  labs(x = "Mean annual temperature", y = "Activation energy", color = NULL, size = "Weight")
```

#### Stage in or out of host?

Stages inside a host may be more shielded from temperature variation than stages in the environment. Let's add this distinction to the model.

```{r}
dat <- mutate(dat, devo_type = if_else(Stage.in.out.of.host == 1, "in host", 
                                       if_else(Stage.in.out.of.host == 2, "outside host", "NA")))
dat$devo_type[which(dat$devo_type == "NA")] <- NA
```


```{r}
mod11 <- MCMCglmm(E_Arr ~ mean_ann_temp_cen + dist_zone + habitat_d1 + endo_ecto2 + devo_type, 
                 random = ~ binomial + tree_tips + idh(stderr_arr):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=63000, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```

This term is not significant and the model DIC is worse.

```{r}
summary(mod11)
```

Though the difference is not significant, worms outside the host have slightly higher AEs, which is also consistent with the idea that environmental variation favors higher AE. The plot also shows that habitat and in/outside host are conflated, as proportionally more of the terrestrial values are outside the host and more of the aquatic values are inside the host.

```{r}
ggplot(dat, aes(x = devo_type, y = E_Arr)) +
  geom_boxplot(outlier.size = NULL, outlier.alpha = 0) +
  geom_point(aes(color = habitat_d1, size = 1/stderr_arr), 
             position = position_jitter(width = 0.25, height = 0)) +
  labs(x = NULL, y = "Activation energy", color = "Habitat", size = "Weight")
```

#### Target host

Stages free in the environment are generally propagules that target the next host in the life cycle. Are the parasites targeting a vertebrate or an invertebrate? It is not obvious to me that this should matter. But nonetheless, we can check it. 

```{r}
# in host - plant or invertebrate?
dat <- mutate(dat, devo_type2 = if_else(devo_type == 'outside host', 'outside host',
                                        if_else(hosts..in.order. == 'plant', 'in plant', 'in invert')))
# outside host - what's the target?
target_vert <- c('amphibian', 'bird', 'mammal', 
                 'mammal (but earthworms & insects possibly paratenic)')

dat <- mutate(dat, 
              devo_type3 = if_else(devo_type2 == 'outside host' & hosts..in.order. == 'plant', 'outside host: targets plant',
                                   if_else(devo_type2 == 'outside host' & hosts..in.order. %in% target_vert, 'outside host: targets vertebrate',
                                           if_else(devo_type2 == 'outside host', 'outside host: targets invert', devo_type2))))
```

Distinguishing between invertebrates and vertebrates as next host does not improve the model.

```{r}
mod12 <- MCMCglmm(E_Arr ~ mean_ann_temp_cen + dist_zone + habitat_d1 + endo_ecto2 + devo_type3, 
                 random = ~ binomial + tree_tips + idh(stderr_arr):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=63000, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```
```{r}
summary(mod12)
```
```{r}
ggplot(dat, aes(x = devo_type3, y = E_Arr, color = devo_type)) +
  geom_boxplot(outlier.size = NULL, outlier.alpha = 0) +
  geom_point(aes(size = 1/stderr_arr), position = position_jitter(width = 0.25, height = 0), alpha = 0.2)+
  coord_flip() +
  labs(x = "Activation energy", y = NULL, color = NULL, size = "Weight")
```


# Conclusions

In this analysis of activation energies in helminths, I account for measurement variance (standard error of activation energy estimates) and I account for two sources of pseudoreplication: (1) multiple measurements on a single parasite species and (2) shared ancestry. A mixed model including both factors suggested that shared ancestry has a clear effect on AEs: related species tend to exhibit similar activation energies.

Next, I evaluated various environmental characteristics and found that activation energies tend to be higher at low temperatures and high latitudes. Finally, I assessed characteristics of the host-parasite interaction, and I found that animal parasites with endotherms in the life cycle tend to have lower AE, consistent with the notion of temperature stability affecting temperature sensitivities.

Finally, let's quantitatively summarize the results. For each of the fitted models, I compiled the df, the DIC, and the R^2^. I calculated R^2^ according to [Nakagawa and Schielzeth 2013](https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/j.2041-210x.2012.00261.x%4010.1111/%28ISSN%292041-210X.STATSTOO). They distinguish between marginal and conditional R^2^. Marginal R^2^ is the proportion of variation explained by the fixed effects while conditional R^2^ is the variation explained by both fixed and random effects. When the term is followed by an asterisk, I retained it in the model.  

```{r}
# the series of models fit
mod_series <- c("just within-species*", "+ phylogeny*", "+ mean annual temp*",
                "+ min/max temps", "+ latitude", "+ distribution zone*", "+ habitat (aquatic vs terrestrial)*",
                "+ distribution x habitat interacton", "+ plant vs animal parasite*", "+ endotherm in life cycle?*",
                "+ stage in/out of host*", "+ target host: invert vs vert")
```
```{r}
# loop through models, collect DIC and df
i <- 0
if(exists("mod_dic")){rm(mod_dic)}
if(exists("mod_df")){rm(mod_df)}
for(m in list(mod0, mod1, mod3, mod4, mod5, mod6, mod7, mod8, mod9, mod10, mod11, mod12)){
  if(i == 0){
    mod_dic <- m$DIC
    mod_df <- m$Fixed$nfl + length(m$Random$nrt)
  } else {
    mod_dic <- c(mod_dic, m$DIC)
    mod_df <- c(mod_df, m$Fixed$nfl + length(m$Random$nrt))
  }
  i <- i + 1
}

```
```{r}
# loop through models, calculate R2
i <- 0
if(exists("r2c")){rm(r2c)}
if(exists("r2m")){rm(r2m)}

for(m in list(mod0, mod1, mod3, mod4, mod5, mod6, mod7, mod8, mod9, mod10, mod11, mod12)){

  # calculate fixed effects var
  fixVar <- numeric(length(m$Sol[,1]))
  for(j in 1:length(m$Sol[,1])){
    fixVar_j <- var(as.vector(m$Sol[j,] %*% t(m$X)))
    fixVar[j] <- fixVar_j
  }
  
  # random effects var
  resi <- which(colnames(m$VCV) == 'units') # remove resid variance from variance components
  randVar <- m$VCV[,-resi]
  if(!is.null(colnames(randVar))){ # if only one random effect, it is unnamed and can't use rowSums
    randVar <- rowSums(randVar)-1
    }
  
  # resid var
  resVar <- m$VCV[,'units']
  
  # calculate R2
  r2m <- (fixVar)/(fixVar + randVar + resVar)
  r2c <- (fixVar + randVar)/(fixVar + randVar + resVar)
  
  if(i == 0){
    r2m_o <- posterior.mode(r2m)
    r2c_o <- posterior.mode(r2c)
  } else {
    r2m_o <- c(r2m_o, posterior.mode(r2m))
    r2c_o <- c(r2c_o, posterior.mode(r2c))
  }
  i <- i + 1
}
```


```{r}
end_tbl <- data.frame(model = mod_series, df = mod_df)
end_tbl <- mutate(end_tbl, df_used = df - lag(df, 1))
end_tbl$DIC <- round(mod_dic, 2)
end_tbl$R2m <- round(r2m_o, 2)
end_tbl$R2c <- round(r2c_o, 2)
```
```{r}
knitr::kable(end_tbl)
```

The most complex model, one that includes phylogeny, seemingly important environmental variables, and characteristics of the host-parasite system, explained over 77% of the variation in activation energy. Much of this is due to the random effects (phylogeny and repeated measures account for >50% of the variation), but around 20% of the variation can be explained by fixed effects. 
