---
title: "Determinants of helminth activation energy"
output: 
  github_document:
    toc: true
    df_print: kable
---

The purpose of this notebook is to explore and model activation energies for helminth development. I previously explored activation energy for both development and mortality. However, fitting thermal performance curves to mortality data proved challenging, and we were not entirely confident in the curve parameters. Therefore, we focus here just on **development**. 

Moreover, I had previously analyzed activation energies estimated with Arrhenius or Sharp-Schoolfield curves separately. However, after adopting more stringent criteria for when to consider SS the better model, we were left with just a handful of curves where SS was considered better. Therefore, in this notebook, I analyze activation energies taken from the "best" curve (usually Arrhenius, sometimes SS).

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(ape)
library(ggtree)
library(RColorBrewer)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
options(stringsAsFactors = FALSE)
theme_set(new = theme_bw())
```
```{r importdata}
# focusing only on devo
ae_devo <- read.csv(file = "../data/200421_ArrDevFits_filter.csv", header = TRUE)
dat <- read.csv(file = "../data/main_data_rev.csv", header = TRUE)
tree <- read.tree(file = "../data/full_tree_time_calib.nex")
```
```{r}
dat <- select(dat, tpc_num, binomial = parasite_species, genus, fam = family, order, class, phylum, 
              trait_type, num_temps = num_temps_in_curve, cause_of_repeated_measures, same_experiment,
              measurement_metric, simplified_metric,
              sampling_location_available,
              mean_ann_temp, max_month_temp, min_month_temp,
              latitude, altitude_m, author_latitude, dist_zone,
              habitat,
              plant_anim_parasite, endotherm_in_cycle, stage_in_out_host, target_host)
```
```{r}
ae_devo <- rename(ae_devo, stderr_arr = SE_BA, stderr_ss = SE_SS)
```

# Get data organized

First, I get the data organized. I combine the curve parameters with the main dataset including info for each parasite species and thermal performance curve.

```{r}
dat <- left_join(dat, ae_devo, by = 'tpc_num') # join by temperature preference curve identifier
dat <- filter(dat, !is.na(E_Arr)) # remove those without Act E
```

How many rows in the main data lack curve parameters?

```{r}
length(filter(ae_devo, !tpc_num %in% dat$tpc_num)$binomial)
rm(ae_devo)
```

No worries there. Since this is a phylogenetic analysis, let's next check the congruence between tree and data table. Here are the species in the data not included in the tree. This is the result of a spelling mistake and after correcting it, all species are included in the tree.

```{r}
dat$binomial[!dat$binomial %in% tree$tip.label]
```

```{r}
# fix it
tree$tip.label[which(tree$tip.label == "Meloidogyne_hisanica")] <- "Meloidogyne_hispanica"
```

```{r}
# dat$binomial[which(dat$binomial == "Protostrongylus _stilesi/rushi (spp.)")] <- "Protostrongylus_stilesi" # this species has sequences avail and is in 'mega tree'
# dat$binomial[which(dat$binomial == "Dochmoides_stenocephala")] <- "Uncinaria_stenocephala" # synonym
# dat$binomial[which(dat$binomial == "Dioctophyma_renale")] <- "Dioctophyme_renale" # misspelling
# dat$binomial[which(dat$binomial == "Ostertagia_circumcincta")] <- "Teladorsagia_circumcincta" # this species has sequences avail and is in 'mega tree'
# dat$binomial[which(dat$binomial == "Trichobiloharzia_.")] <- "Trichobilharzia_sp." # this species 
```
```{r}
# dat$binomial[!dat$binomial %in% tree$tip.label]
```
```{r}
spp_not_in_dat <- tree$tip.label[!tree$tip.label %in% dat$binomial] # spp in tree excluded from data
# spp_not_in_dat
```
```{r}
tree_red <- drop.tip(tree, spp_not_in_dat)
```

How many AE estimates are there for worm development?

```{r}
length( na.omit(dat$E_Arr) )
```

How many unique species are in the data?

```{r}
length(unique(dat$binomial))
```

Tips on tree?

```{r}
length(tree_red$tip.label)
```

Taxonomic breakdown

```{r}
dat%>%
  select(binomial, phylum)%>%
  distinct()%>%
  group_by(phylum)%>%
  summarize(num_sp = n())
```


### The response - activation energy

Now that the data are organized, we can look at the response variable, activation energy. Activation energy was estimated from thermal performance curves two ways, either with Arrhenius or Sharpe-Schoolfied equations.

```{r}
dat <- mutate(dat, E_comb = if_else(best_mod2 == "SS", E_SS, E_Arr),
              se_comb = if_else(best_mod2 == "SS", stderr_ss, stderr_arr))
```

Which of these fit better was judged by likelihood ratio tests, and it was an almost 50-50 split.

```{r}
round(prop.table(table(dat$best_mod)), 2)
```

However, the estimates from the two models clearly differed, as shown by the density plot below. When SS was considered better, the AE estimates were higher. When Arr was considered better, the AE estimates were lower. This is why I previously analyzed the Arr and SS estimates separately. 

```{r}
ggplot(dat, aes(x = E_comb, color = best_mod)) +
  geom_density(binwidth = 0.05) +
  labs(x = "Activation energy estimate", color = "Best mod, LRT")
```

Looking at the curve fits, though, suggested that SS was sometimes considered better even in cases where there was not a well defined peak in the curve. To be sure that SS was an appropriate model, stricter criteria were used. SS was only considered better when there were at least 5 points in the curve and the curve had a clear peak with two points beyond the peak. After applying these criteria, the proportion of curves better fit by SS was much lower.

```{r}
round(prop.table(table(dat$best_mod2)), 2)
(table(dat$best_mod2))
```

Here is the AE distribution. Overall, the median activation energy was `r round(median(dat$E_comb), 2)`. The few curves better fit by SS do not have obviously different AEs.

```{r}
# median(dat$E_comb)
```
```{r}
ggplot(dat, aes(x = E_comb, fill = best_mod2)) +
  geom_histogram(binwidth = 0.05) +
  labs(x = "Activation energy estimate", color = "Best mod, strict")
```

Some curves have more data points and are better fit than others. Standard error take into account both the number of points in the curve and the fit. Therefore, let's look at standard errors as a way to weigh data points (i.e. meta-analysis).

Here's the distribution of standard error estimates for the activation energies. There is at least one outlier where the curve fits poorly (it is curve 237, which is characterized by a few unusual data points).

```{r}
ggplot(dat, aes(x = se_comb)) +
  geom_histogram()
```
```{r}
# filter(dat, se_comb > 0.5)
```

The curves with high SE are not those with high activation energies. 

```{r}
ggplot(dat, aes(y = se_comb, x = E_comb)) + 
  geom_point(aes(color = best_mod2)) +
  geom_smooth(se=F) +
  labs(x = "Activation Energy", y = "SE", color = 'Best mod, strict')
```

All else equal, we should have more confidence in curves fit with a larger number of temperatures. To reflect this, standard error should decrease with sample size (i.e. number of temperatures). But this is not obviously the case.

```{r}
ggplot(dat, aes(x = num_temps, y = se_comb)) +
  geom_point(aes(color = best_mod2), alpha = 0.5) + 
  geom_smooth() +
  labs(x = "Number of temps in curve", y = "SE", color = 'Best mod, strict')
```

When we zoom in to exclude the outliers, there is still not a strong relationship between standard error and the number of temperatures. However, the largest standard errors are observed with the lowest sample sizes (left-hand part of plot), which is reassuring.

```{r}
ggplot(filter(dat, se_comb < 0.5),
       aes(x = num_temps, y = se_comb)) +
  geom_point(aes(color = best_mod2), alpha = 0.5) + 
  geom_smooth() +
  labs(x = "Number of temps in curve", y = "SE", color = 'Best mod, strict')
```

With less precision (higher standard errors), we would expect a broader distribution of activation energy estimates. Let's look at the distribution of activation energies split by whether standard error was high or low (above or below the median SE). The AE distribution is not wider with higher standard errors, though it might be a bit shifted towards higher values.

```{r}
dat <- mutate(dat, se_cat = if_else(se_comb > median(se_comb, na.rm = T), "high standard error", "low standard error"))
```
```{r}
ggplot(dat, aes(x = E_comb, color = se_cat)) + 
  geom_density() + labs(x = "AE", color =NULL)
```

Poorly fit curves (above average SE) had slightly higher median AE compared to better fitting curves.

```{r}
group_by(dat, se_cat)%>%
  summarize(median_AE = median(E_comb), 
            upr_90quant = quantile(E_comb, probs = 0.95),
            lwr_90quant = quantile(E_comb, probs = 0.05))
```

Thus, when we weight the data points by the standard error of the activation energies, it should shift the overall mean down.

Here are some descriptives from the manuscript:

```{r}
summary(dat$num_temps)
```


## Apparent parasite development - same experiment, different metrics

In some cases, multiple TPCs were fit to data from the same experiment. For example, one curve fit for minimum developmental time and one for maximum developmental time. These are not independent because the same individual parasites contribute to both metrics. In these cases AE measurements should be highly correlated.

Let's make a plot for the species with multiple activation energy measurements. When we do this, we see that AE estimates from the same experiment tend to cluster as expected.

```{r}
mm <- group_by(dat, binomial)%>%
  summarize(AE = median(E_comb, na.rm = T), n = n())%>%
  arrange(AE)
sp_mm <- mm$binomial[which(mm$n>1)] # species with multiple measurements
```
```{r}
ggplot(filter(dat, binomial %in% sp_mm)%>%
         mutate(bi_o = factor(binomial, levels = sp_mm)),
       aes(x = bi_o, y = E_comb, color = same_experiment)) +
  geom_point(alpha = 0.5) +
  coord_flip() +
  labs(x = "Species", y = "Activation energy", color = "Same experiment?") +
  theme(panel.grid.minor = element_blank())
```

This indicates these values are not independent. Since this is an issue that only affects a few species, I'm not inclined to devise an `experiment` random effect that accounts for this pseudoreplication. Rather, I only take a single AE per experiment. But which one?

We can zoom in on just these cases where there are multiple measurements from the same experiment. There is a consistent pattern: activation energy is higher when the metric is minimum development time than when it is maximum development time. 

```{r}
ggplot(filter(dat, binomial %in% sp_mm, same_experiment == 'yes')%>%
         mutate(bi_o = factor(binomial, levels = sp_mm)),
       aes(x = bi_o, y = E_comb, color = simplified_metric)) +
  geom_point(alpha = 1) +
  facet_grid(~trait_type, scales = 'free_x') +
  coord_flip() +
  labs(x = "Species", y = "Activation energy", color = "Metric") +
  theme(panel.grid.minor = element_blank())
```

This also highlights the concerns Peter has raised about *apparent* developmental rates, in that development is not measured for all viable worms (ones that die before maturing are excluded). For instance, mortality is probably more important if devo time is defined as the time for the last parasite to reach a certain developmental milestone (i.e. max devo time) than if it's defined as the time for the first parasite to reach the milestone (min devo time), because fewer parasite have died and are unobserved. 

We can examine how activation energy varies with the developmental metric across the whole dataset. It does not follow the same pattern as within an experiment. For example, the 'max' group is higher than the 'min' group overall, while this was reversed within experiments.

```{r}
ggplot(dat, aes(y = E_comb, x = simplified_metric)) + 
  geom_boxplot(outlier.color = NA) +
  geom_point(position = position_jitter(width = 0.2, height = 0), alpha = 0.5) +
  coord_flip() +
  facet_grid(~trait_type, scales = 'free_x') +
  labs(y = "Activation energy") +
  theme(axis.title.y = element_blank())
```

Overall, most activation energies were based on mean development times. Thus, in the few cases where multiple TPCs were fit to data from the same experiment, but different metrics, I will retain only the activation energy estimated with the mean.

```{r}
dat <- filter(dat, !(same_experiment == "yes" & simplified_metric != 'mid'), !tpc_num %in% c(61)) # remove non-ind data
```

After removing AEs from the same experiment, how many AE estimates per species? Usually just one, but up to 8.

```{r}
filter(dat, !is.na(binomial), !is.na(E_comb))%>%
  group_by(binomial)%>%
  summarize(n = n())%>%ungroup()%>%
  select(n)%>%
  summary(.)
```

In some cases, the source of repeated measures on a single species was recorded. For example, the temperature dependence of multiple parasite populations or life stages was studied. We can also plot these variables the same way as above. I do not notice any obvious patterns. 

```{r}
mm <- group_by(dat, binomial)%>%
  summarize(AE = median(E_comb, na.rm = T), n = n())%>%
  arrange(AE)
sp_mm <- mm$binomial[which(mm$n>1)] # species with multiple measurements

ggplot(filter(dat, binomial %in% sp_mm)%>%
         mutate(bi_o = factor(binomial, levels = sp_mm)),
       aes(x = bi_o, y = E_comb, color = cause_of_repeated_measures)) +
  geom_point(alpha = 0.5) +
  coord_flip() +
  facet_wrap(~trait_type) +
  labs(x = "Species", y = "Activation energy", color = "Different:")
```

Since life stages or populations of the same parasite species may have different temperature sensitivities, I would retain these in the data.

## Phylogeny 

To visualize phylogenetic effects, I'll randomly take one AE per species. 

```{r}
dat_1per_sp <- dat%>%group_by(binomial)%>%sample_n(1)
```

This reduces the data from n = `r length(dat$binomial)` to n = `r length(dat_1per_sp$binomial)`.
Here is the distribution of activation energies across the tree. Maybe some clades have higher values, but it is not obvious. The cases where SS was chosen as the better model are not bunched into a single clade, suggesting they will not confound or exacerbate phylogenetic effects.

```{r}
tree_df <- fortify(tree_red)
tree_df <- left_join(tree_df, dat_1per_sp, by = c("label" = "binomial"))
```
```{r}
p <- ggtree(tree_df)
facet_plot(p, panel = 'Activation Energy', 
           data = select(ungroup(dat_1per_sp), id = binomial, val = E_comb),
           geom = geom_segment, aes(x=0, xend = val, y = y, yend = y, color = best_mod2))
```

# Phylogenetic mixed models

I'll fit phylogenetic mixed models (see [here](https://onlinelibrary.wiley.com/doi/full/10.1111/j.1420-9101.2009.01915.x) for an overview of these models) using the `MCMCglmm` library. These are not simple models, but the Bayesian `MCMCglmm` package does allow us to fit both within- and between-species effects in the same model. It also allows us to weight the activation energies by their standard errors.

Before diving into the models, though, let's outline a model-building strategy. I see two major steps: (1) addressing methological concerns and (2) exploring biological covariates. Let's consider the methodological concerns first. From the outset, I weight each data point by the standard error of activation energy. This weight was incorporated into the model as suggested [here](https://ourcodingclub.github.io/2018/01/22/mcmcglmm.html) and in the `MCMCglmm` course notes. There are also two sources of pseudoreplication: within-species and between-species variation. Some species have multiple AE estimates (e.g. from different hosts, studies, populations, stages, etc.), while related species are expected to have similar AEs, given their shared ancestry. Both these are included as random effects. Other methodological concerns are addressed with fixed effects, such as how rates were recorded (e.g. min, max, etc.).

Now that we are at the modeling stage, let's also list a few descriptives.

Number of curves: 

```{r}
length(dat$binomial)
```

Number of species

```{r}
length(unique(dat$binomial))
```

Number of temps per curve

```{r}
summary(dat$num_temps)
```

Number fit by each model:

```{r}
t<-table(dat$best_mod2)
t
round(prop.table(t),2)
```

Median activation energy

```{r}
summary(dat$E_comb)
```

## Methodological issues and the "base" model
### Within-species effect

First, I create a "base" model that accounts for pseudoreplication. The first step towards that model is including a parasite species random effect, but not a phylogenetic effect. Throughout, data points are weighted by their standard error.

```{r}
library(MCMCglmm)
```
```{r}
prior1<-list(G=list(G1=list(V=1,nu=0.002), # uninformative prior for within species effect
                     G2=list(V=1,fix=1)), # btw observation variance due to measurement errror/SE of curve fit - fixed!
              R=list(V=1,nu=0.002)) 
```

```{r}
mod00 <- MCMCglmm(E_comb ~ 1, # intercept only, SE weighted
                  random = ~ idh(se_comb):units,
                  data = dat,
                  prior = list(G=list(G1=list(V=1,fix=1)),R=list(V=1,nu=0.002)), # fix prior for SE weights
                  nitt=13000, thin = 10,
                  family = "gaussian", pr=F, verbose = F)

mod0 <- MCMCglmm(E_comb ~ 1, 
                 random = ~ binomial + idh(se_comb):units, # w/in spp effx
                 data = dat,
                 prior = prior1,
                 nitt=13000, thin = 10,
                 family = "gaussian", pr=F, verbose = F)
```

After fitting an MCMC model, a first quality check is looking at chain mixing. Essentially, we want the chain to bounce back and forth randomly - it shouldn't get stuck at particular parameter estimates.

```{r}
plot(mod0$VCV)
```

The within-species effect, `binomial`, mixes well and is non-zero, suggesting that multiple AE measurements on the same species tend to be similar. The variance component for `se` is fixed at 1, such that the standard error weights do not change as the posterior distribution is sampled by the Markov chain.

Here is the model summary. The model intercept represents the average activation energy.

```{r}
summary(mod0)
```

The information criteria returned by `MCMCglmm` is the Deviance Information Criterion (DIC). We can use it to compare models. Judged on DIC, adding a within-species random effect is a clear improvement.

```{r}
cat("Delta DIC, intercept-only model vs model with within-species random effect (higher is better):\t", 
    mod00$DIC - mod0$DIC,
    sep = "")
```

Here's the proportion of variation attributable to the within-species effect. 

```{r}
phy_h2 <- mod0$VCV[,'binomial']/(mod0$VCV[,'binomial'] + mod0$VCV[,'units'])
summary(phy_h2)
```

It is definitely non-zero and suggests that species measured multiple times tend to have very similar AE estimates, although there is a fairly wide spread in the estimated AEs for some species. 

```{r}
mm <- group_by(dat, binomial)%>%
  summarize(AE = median(E_comb, na.rm = T), n = n())%>%
  arrange(AE)
sp_mm <- mm$binomial[which(mm$n>1)] # species with multiple measurements
```
```{r}
ggplot(filter(dat, binomial %in% sp_mm)%>%
         mutate(bi_o = factor(binomial, levels = sp_mm)),
       aes(x = bi_o, y = E_comb)) +
  geom_point(alpha = 0.5) +
  coord_flip() +
  labs(x = "Species", y = "Activation energy (Arrhenius)") +
  theme(panel.grid.minor = element_blank())
```

The `species` effect is also likely inflated because many species only had a single measurement (and hence no residual value after accounting for a 'species effect').

### Phylogenetic effect

Now, let's add phylogenetic effects to the model to examine variation between species. We create the phylogenetic covariance matrix and then include it as a random effect.

```{r}
tree_red2 <- makeNodeLabel(tree_red) # standardize node labels
Ainv <- inverseA(tree_red2)$Ainv # make inv of phy cov matrix

dat$tree_tips <- dat$binomial
```
```{r}
prior2<-list(G=list(G1=list(V=1,nu=0.002),
                    G2=list(V=1,nu=0.002),
                    G3=list(V=1,fix=1)), # btw observation variance due to measurement errror/SE of curve fit
              R=list(V=1,nu=0.002)) # uninformative prior for within species effect
iter <- 103000 # number of MCMC iterations used in phylo models throughout
```

For this model, the chain needs to be run for longer to get reasonable mixing, partly because the two random effects are related. If the model estimates higher values for the within-species variance component, it estimates less for the phylogenetic component, and vice versa. 

```{r}
mod01 <- MCMCglmm(E_comb ~ 1, 
                 random = ~ tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat, 
                 prior = prior1,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod1 <- MCMCglmm(E_comb ~ 1, 
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat, 
                 prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```

After fitting, we can again plot the chains. They look ok. The within-species effect (`binomial`) is closer to zero than the phylogenetic effect (`tree_tips`). 

```{r}
plot(mod1$VCV)
```

These results suggest that phylogenetically related species tend to have similar AEs, and when a species is measured multiple times, the estimated AEs are similar, though they are not far more similar than what they are expected to be based on phylogeny (i.e. the within-species effect does not explain much additional variation beyond phylogeny).

Here is the amount of variation around the mean AE attributed to the phylogenetic effect. It is high, but with wide credible intervals.

```{r}
phy_h2 <- mod1$VCV[,'tree_tips']/(mod1$VCV[,'tree_tips'] + mod1$VCV[,'binomial'] + mod1$VCV[,'units'])
# round(median(phy_h2), 2) * 100
summary(phy_h2)
```

By contrast, the 'species' effect explained less of the variation in AE.

```{r}
phy_h2 <- mod1$VCV[,'binomial']/(mod1$VCV[,'tree_tips'] + mod1$VCV[,'binomial'] + mod1$VCV[,'units'])
# round(median(phy_h2), 2) * 100
summary(phy_h2)
```

Thus far, the models suggest that (i) species measured multiple times have similar AE values and (ii) related species have similar AE values. Accordingly, adding the phylogenetic random effect to the model with just within-species variation is an improvement.

```{r}
cat("Delta DIC, within-species random effect vs phylogenetic random effect (higher is better):\t", 
    mod0$DIC - mod1$DIC,
    sep = "")
```

We can further decompose these effects by fitting a taxonomic mixed model instead of a phylogenetic one. Specifically, instead of the phylogeny, we have nested taxonomic random effects. This let's us explore whether phylogenetic structure is at the tips (i.e. differences between genera) or the root of the tree (differences between phyla).

```{r}
prior_tax <- list(G=list(G1=list(V=1,nu=0.002),
                         G2=list(V=1,nu=0.002),
                         G3=list(V=1,nu=0.002),
                         G4=list(V=1,nu=0.002),
                         G5=list(V=1,nu=0.002),
                         G6=list(V=1,nu=0.002),
                         G7=list(V=1,fix=1)), # btw observation variance due to measurement errror/SE of curve fit
              R=list(V=1,nu=0.002)) # uninformative prior for within species effect
```

```{r}
mod1_tax <- MCMCglmm(E_comb ~ 1, 
                 random = ~ binomial + genus + fam + order + class + phylum +
                   idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat, 
                 prior = prior_tax,
                 nitt=iter, thin = 50,
                 family = "gaussian", pr=F, verbose = F)
```

After fitting the model, we want to compare the estimated variance component for each taxonomic level. To make the variance components easier to interpret, we express them as a proportion of the total variance. For example, the variance accounted for by "genus" is the genus variance component divided by the summed taxonomic and residual variance components. We'll also compare taxonomic and phylogenetic models, just in case some of the nodes in the phylogeny are especially important (a phylogenetic tree is more resolved than a taxonomic one).

The total variation explained by the phylogenetic and taxonomic models were quite similar, suggesting we would not lose much by using taxonomy instead of phylogeny. It was also higher than in the model with just the within-species effect, suggesting higher taxonomic groupings also explain variation in AE. The largest taxonomic effect was for families, suggesting differences between families and similarity within them. However, the differences among taxonomic levels were small and quite variable, which is expected given that their effects are nested and thus confounded with each other.

```{r}
tax_eff <- rbind(
  quantile(mod1_tax$VCV[,1]/(rowSums(mod1_tax$VCV[,1:8])-1), probs = c(0.025, 0.5, 0.975)),
  quantile(mod1_tax$VCV[,2]/(rowSums(mod1_tax$VCV[,1:8])-1), probs = c(0.025, 0.5, 0.975)),
  quantile(mod1_tax$VCV[,3]/(rowSums(mod1_tax$VCV[,1:8])-1), probs = c(0.025, 0.5, 0.975)),
  quantile(mod1_tax$VCV[,4]/(rowSums(mod1_tax$VCV[,1:8])-1), probs = c(0.025, 0.5, 0.975)),
  quantile(mod1_tax$VCV[,5]/(rowSums(mod1_tax$VCV[,1:8])-1), probs = c(0.025, 0.5, 0.975)),
  quantile(mod1_tax$VCV[,6]/(rowSums(mod1_tax$VCV[,1:8])-1), probs = c(0.025, 0.5, 0.975)),
  quantile(rowSums(mod1_tax$VCV[,1:6])/(rowSums(mod1_tax$VCV[,1:8])-1), probs = c(0.025, 0.5, 0.975)),
  quantile(mod1$VCV[,'binomial']/(rowSums(mod1$VCV)-1), probs = c(0.025, 0.5, 0.975)),
  quantile(mod1$VCV[,'tree_tips']/(rowSums(mod1$VCV)-1), probs = c(0.025, 0.5, 0.975)),
  quantile(rowSums(mod1$VCV[,1:2])/(rowSums(mod1$VCV)-1), probs = c(0.025, 0.5, 0.975)),
  quantile(mod01$VCV[,'tree_tips']/(rowSums(mod01$VCV)-1), probs = c(0.025, 0.5, 0.975)),
  quantile(mod0$VCV[,'binomial']/(rowSums(mod0$VCV)-1), probs = c(0.025, 0.5, 0.975))
)

tax_eff <- data.frame(tax_eff)
names(tax_eff) <- c('vc.lwr', 'vc.fit', 'vc.upr')
tax_eff$t_level <- c('species', 'genus', 'family', 'order', 'class', 'phylum', 'total',
                     'species', 'tree', 'total', 'total', 'total')
tax_eff <- mutate(tax_eff, 
                  t_level = factor(t_level, levels = c('species', 'genus', 'family', 'order', 'class', 'phylum', 'tree', 'total')),
                  model = c(rep('taxonomy', times = 7), rep('phylogeny+w/in spp', times = 3), 
                            'phylo only', 'w/in spp\nonly'))%>%
  mutate(model = factor(model, levels = c('w/in spp\nonly', 'phylo only', 'phylogeny+w/in spp', 'taxonomy' )))

ggplot(tax_eff, aes(x = t_level, y = vc.fit)) +
  geom_pointrange(aes(ymin = vc.lwr, ymax = vc.upr, color = t_level == 'total')) +
  labs(x = NULL, 
       y = 'Proportion of variance in AE explained') +
  guides(color = FALSE) +
  facet_grid(~model, scales = 'free_x', space = 'free_x') +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank())
```

Here is the variance explained by phylogeny:

```{r}
tax_eff%>%
  filter(model == "phylo only")
```

and by taxonomy:

```{r}
tax_eff%>%
  filter(model == "taxonomy", t_level == "total")
```

Here are the variance components for each taxonomic levels:

```{r}
tax_eff%>%
  filter(model == "taxonomy")
```

Here's a plot splitting AE by parasite family. It does look like some clades tend to have higher or lower AEs. However, some differences might just be species-level effects, given that sometimes there is just one AE estimate for the family.

```{r}
ord_A <- group_by(dat, fam)%>%
  summarize(AE = median(E_comb, na.rm=T))%>%
  arrange(AE)

ggplot(mutate(dat, ord_A = factor(fam, levels = ord_A$fam)),
       aes(x = ord_A, y = E_comb, color = phylum)) + 
  geom_boxplot(outlier.color = NA) +
  geom_point(alpha = 0.5, position = position_jitter(width = 0.2), aes(size = 1/se_comb)) + 
  coord_flip() +
  theme(axis.title.y = element_blank()) +
  labs(size = "Weight - 1/SE", y = "Activation energy")
rm(ord_A)
```

Let's proceed with the model that includes both a phylogenetic effect, given that it is more resolved than taxonomy, and a within-species effect, as it acknowledges the non-independence in the data, even if it overlaps with the phylogenetic effect. Now we can examine some other methodological covariates.

#### Development metric

The chosen metric of development can affect activation energy estimates, at least within experiments. This was less clear across experiments. To check this effect, I added a fixed factor to the model that distinguishes between activation estimates based on mean, min, or unspecific development times.

```{r}
mod3 <- MCMCglmm(E_comb ~ simplified_metric, 
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```

The differences among metrics were minimal (non-significant p-values). 

```{r}
summary(mod3)
```

Thus, it is not clear how valuable the `metric` term is. It does not "correct" activation energies in the direction we would expect, it is very weakly related to AE, and it does not improve the model, as judged by DIC.

```{r}
cat("Delta DIC, model with vs without 'metric' (higher is better):\t", mod1$DIC - mod3$DIC,
    sep = "")
```

Therefore, I have not included `metric` in further analyses.

## Biological covariates of activation energy

Now, I add biologically interesting variables to the base model. I categorize these variables into two groups: (1) characteristics of the external environment and (2) characteristics of the host-parasite system. We'll start with environmental variables.

### Environmental variables

Although we now examine environmental covariates, it is important to keep phylogeny in mind. Essentially, any explanatory variable that is phylogenetically structured will "compete" with the phylogenetic random effect to explain variation in AE.

I have tried to find a series of logical steps to testing environmental correlates of helminth AE. First and foremost, we expect AE to be related to environmental temperature, so I start with temperature variables.

#### Mean temperature

There are three temperature measurements in the data: mean, max, and min for the location. I would expect the three temp variables to be tightly correlated, so let's start by just adding the mean to the model. Note that I have centered the continuous variables around their median, such that the model parameters are estimated at the data's median annual temperature.

```{r}
dat <- mutate(dat, mean_ann_temp_cen = mean_ann_temp - median(mean_ann_temp),
              max_month_temp_cen = max_month_temp - median(max_month_temp),
              min_month_temp_cen = min_month_temp - median(min_month_temp))
```

```{r}
mod4 <- MCMCglmm(E_comb ~ mean_ann_temp_cen, 
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```

The effect of mean locale temperature is negative but not quite significant.

```{r}
summary(mod4)
```

The model fit is not better as judged by DIC.

```{r}
cat("Delta DIC, model with vs without mean temp (higher is better):\t", mod1$DIC - mod4$DIC,
    sep = "")
```

Here's the plot. Each point is scaled by its weight (inverse SE).

```{r}
ggplot(dat, aes(x = mean_ann_temp, y = E_comb)) +
  geom_point(alpha = 0.5, aes(size = 1/se_comb)) +
  labs(color = "exact location?", size = "Weight, 1/SE", y = "AE") +
  geom_smooth(method = lm, se = F) 
```

Another issue to consider, though, is that exact sampling locations were not available for every species and in many cases the author's address was taken as the study location. These data points may therefore be expected to be less correlated with AE, as seems to be the case.

```{r}
ggplot(dat, aes(x = mean_ann_temp, y = E_comb, color = sampling_location_available)) +
  geom_point(alpha = 0.5, aes(size = 1/se_comb)) +
  labs(color = "exact location?", size = "Weight, 1/SE", y = "AE") +
  geom_smooth(method = lm, se = F) 
```

Let's try to add this to the model. We allow temperature effects to depend on whether an exact sampling location was known.

```{r}
# temp effect on AE depends on author loc or not
mod4.2 <- MCMCglmm(E_comb ~ mean_ann_temp_cen * sampling_location_available, 
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```

This does not clearly improve the model, as judged by DIC.

```{r}
cat("Delta DIC, mean temp main effect vs temp x location interaction (higher is better):\t", 
    mod4$DIC - mod4.2$DIC,
    sep = "")
```

Here's the model output:

```{r}
summary(mod4.2)
```

Given that temp is a main focus of the analysis, let's continue with a model including temperature but not its interactions.

#### Temperature variation

A mean temperature does not indicate the temperature range a parasite is exposed to. Thus, as the next modelling step, we'll include location min and max temps. 
```{r}
mod5 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + 
                   max_month_temp_cen + min_month_temp_cen, 
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```

None of these terms are significant, and the model DIC is not better.

```{r}
summary(mod5)
```
```{r}
cat("Delta DIC, mean temp main effect vs model with min and max temp (higher is better):\t", 
    mod4$DIC - mod5$DIC,
    sep = "")

```

When we plot AE as a function of max and min temp, we see negative relationships just like for mean temp: low temps, high AE. The interaction with location coding may be a bit different, but I chose not to look at the interaction betwen location, max, and min temps, given that they probably overlap a lot with mean temperature.

```{r}
ggplot(dat, aes(x = max_month_temp, y = E_comb, color = sampling_location_available)) +
  geom_point(alpha = 0.5, aes(size = 1/se_comb )) +
  labs(color = "exact location?", size = "Weight", y = "Activation energy") +
  geom_smooth(method = lm, se = F)
```

```{r}
ggplot(dat, aes(x = min_month_temp, y = E_comb, color = sampling_location_available)) +
  geom_point(alpha = 0.5, aes(size = 1/se_comb )) +
  labs(color = "exact location?", size = "Weight", y = "Activation energy") +
  geom_smooth(method = lm, se = F)
```

Is there a good biological reason to include extreme temps in the model? On the one hand, we could expect that temperature variability affects activation energy. On the other hand, a lower min temperature might not matter much if parasites do not develop below a certain threshold that is unlinked to the minimum temperature. Also, if temperature variability is what drives activation energy, then we would expect the parameter estimates for min and max to go in opposite directions, i.e. larger temperature extremes are associated with higher (or lower) AE values. Since (i) these results are confounded with mean temperature and (ii) we test several other proxies of seasonality/temperature variability, my preference is to drop min and max temp from the model.

#### Seasonality

Variation in temperature is one component of seasonality, but not the only one. Photoperiod, rainfall, or other environmental factors may vary with seasons and impact the thermal-dependence of parasite development. The dataset contains two variables that might capture seasonality: latitude and distribution. Distribution zones were defined as 'tropics', 'temperate', 'polar', and 'global', which means this variable overlaps substantially with latitude. Consequently, I examine these two variables in parallel, not putting both in the same model.

##### Latitude

Let's look at latitude first; it is a single continuous variable while distribution is multiple categories. In some cases, a study gave a detailed location, so our data contains exact latitudes. In other cases, no site was given and the author's location was taken as a rough proxy of the study's location. Most records were from the Northern hemisphere, but a few were from the Southern hemisphere. Thus, I took the absolute value of latitude, essentially the distance from the equator.

```{r}
dat <- mutate(dat, lat_abs = if_else(latitude == ".", abs(as.integer(author_latitude)), abs(as.integer(latitude))))%>%
  mutate(lat_abs_cen = lat_abs - median(lat_abs))
```

```{r}
mod6 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen,
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```

The effect of latitude on AE is not significant...

```{r}
summary(mod6)
```

...and not an improvement as judged by DIC.

```{r}
cat("Delta DIC, mean temp main effect vs model with latitude added (higher is better):\t", 
    mod4$DIC - mod6$DIC,
    sep = "")
```

Surprisingly, the parameter estimate for latitude is negative, but when we plot it, we see that activation energies tend to slightly increase with latitude, as we would expect given the temp results above.

```{r}
ggplot(dat, aes(x = lat_abs, y = E_comb)) + 
  geom_point(alpha = 0.5, aes(size = 1/se_comb )) +
  geom_smooth(method = lm, se = F) +
  labs(x = 'latitude', color = "exact location?",size = "Weight", y = "Activation energy") 
```

This suggests that correlations among variables (here between mean temp and latitude) might cause counterintuitive results. When we remove the effect of mean temperature on activation energy (i.e. we take the residuals of the model with mean temp but not latitude), and then plot the residual variation as a function of latitude, we see essentially no relationship between latitude and activation energy.

```{r}
preds <- predict(mod4) # predicted values with mean temp and temp x trait interaction
```
```{r}
ggplot(dat, aes(x = lat_abs, y = preds - E_comb)) +
  geom_point(alpha = 0.5, aes(size = 1/se_comb )) +
  labs(color = "exact location?", size = "Weight", x = "latitude", y = "Residual, mean temp only") +
  geom_smooth(method = lm, se = F) 
```

Latitude effects, like temp, may depend on trait and location availability. When we plot this, we see a bit clearer increase in AE with latitude, when the location was precisely known.

```{r}
ggplot(dat, aes(x = lat_abs, y = E_comb, color = sampling_location_available)) + 
  geom_point(alpha = 0.5, aes(size = 1/se_comb )) +
  geom_smooth(method = lm, se = F) +
  labs(x = 'latitude', color = "exact location?",size = "Weight", y = "Activation energy") 
```

```{r}
mod6.1 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen*sampling_location_available,
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```

However, adding this interaction was not a clear improvement to the model.

```{r}
cat("Delta DIC, latitude main effect vs latitude x location interaction (higher is better):\t", 
    mod6$DIC - mod6.1$DIC,
    sep = "")
```

Let's look at the next seasonality proxy, which is related to latitude.

##### Climate zones

Our latitude variable does not perfectly capture a parasite's thermal habitat. Many species are associated with people or livestock and have thus been moved all around the world. This is reflected in the distribution zone variable: it contains a category for parasites with a global distribution.

However, the distribution categories are still tightly linked to latitude.

```{r}
ggplot(dat, aes( x = dist_zone, y = lat_abs)) +
  geom_boxplot(outlier.colour = NA) +
  geom_point(alpha = 0.5, position = position_jitter(width = 0.2)) +
  labs(x = NULL, y = 'Latitude')
```

Let's add this variable to the model instead of latitude. None of the contrasts among these categories are significant.

```{r}
mod7 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + dist_zone,
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```

```{r}
summary(mod7)
```

Accordingly, the model was not a clear improvement.

```{r}
cat("Delta DIC, mean temp main effect vs model with latitude added (higher is better):\t", 
    mod4$DIC - mod7$DIC,
    sep = "")
```

Consistent with the pattern for temperature and latitude, polar species tend to have higher AE, but the other groups are all rather similar. 

```{r}
ggplot(dat, aes( x = dist_zone, y = E_comb)) +
  geom_boxplot(outlier.colour = NA) +
  geom_point(alpha = 0.5, position = position_jitter(width = 0.2), aes(size = 1/se_comb)) +
  # facet_wrap(~trait_type) +
  labs(x = NULL, y = 'Activation energy', size = "Weight")
```

The main difference between the latitude and zone variables is that zone acknowledges some parasite species are globally distributed. Let's again look at the effect of latitude, but now distinguish between globally-distributed species and more localized ones.

```{r}
dat <- mutate(dat, global = if_else(dist_zone == 'global', 'global', 'not global'))
```

The latitude-AE relationship is similar for global and local parasites, though I would have expected a weaker relationship for global species.

```{r}
ggplot(dat, aes(x = lat_abs, y = E_comb, color = global)) + 
  geom_point(alpha = 0.5, aes(size = 1/se_comb )) +
  geom_smooth(method = lm, se = F) +
  # facet_wrap(~trait_type) +
  labs(x = 'latitude', color = "Distribution",size = "Weight", y = "Activation energy") 
```

Surprisingly, allowing the latitude effect to depend on distribution (global vs not global) slightly improves the model.

```{r}
mod7.2 <- MCMCglmm(E_comb ~  mean_ann_temp_cen + lat_abs_cen*global,
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```
```{r}
cat("Delta DIC, latitude main effect vs latitude x global interaction (higher is better):\t", 
    mod6$DIC - mod7.2$DIC,
    sep = "")
```

But when we look at the model summary, the latitude and distribution parameters are not significant.

```{r}
summary(mod7.2)
```

Nonetheless, I'll retain the latitude by global distribution interaction in the model, simply because it seems like a reasonable proxy for seasonality, at least *a priori*. However, the latitude parameter is hard to interpret (negative?), it is confounded with temperature, and it does not seem to differ for globally-distributed species vs local ones.

#### Habitat - aquatic vs freshwater

As a final environmental variable, we add parasite habitat: aquatic vs terrestrial. Water dampens temperature swings, such that seasonality is less pronounced in aquatic habitats compared to terrestrial ones. Thus, this variable might also modify the effect of seasonality proxies like latitude.

```{r}
# make habitat variable easy to understand
dat <- mutate(dat, habitat_d1 = if_else(habitat == 'terrestrial', 'terrestrial',
                                        if_else(habitat == 'freshwater' | habitat == 'marine', 'aquatic', 'NA')))
dat$habitat_d1[which(dat$habitat_d1 == "NA")] <- NA

# sum(is.na(dat$habitat_d))
```
```{r}
mod8 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen*global + habitat_d1,
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```

Adding habitat clearly improves the model.

```{r}
cat("Delta DIC, adding habitat (higher is better):\t", 
    mod7.2$DIC - mod8$DIC,
    sep = "")
```

The parameter indicates terrestrial species have higher activation energies on average than aquatic species (mostly freshwater species, but a few marine).

```{r}
summary(mod8)
```
Here's the plot.
```{r}
# dat%>%group_by(habitat_d1)%>%summarize(median_AE = median(E_comb))
```
```{r}
ggplot(filter(dat),
       aes(x = habitat_d1, y = E_comb)) +
  geom_boxplot(outlier.colour = NA) +
  geom_point(aes(size = 1/se_comb), position = position_jitter(width = 0.2), alpha = 0.3) +
  # facet_wrap(~trait_type) +
  labs(size = "Weight", y = "Activation Energy", x = NULL) 
```

We might expect the aquatic - terrestrial dichotomy to be particularly important in more seasonal locations. That is, there may be an interaction between our seasonality proxy (latitude) and habitat. The increase in AE with latitude mainly occurs in terrestrial species, which makes sense, as terrestrial environments are less temperature buffered than aquatic ones.

```{r}
ggplot(filter(dat, !is.na(habitat_d1)),
       aes(x = lat_abs, y = E_comb, color = habitat_d1)) +
  geom_point(aes(size = 1/se_comb), position = position_jitter(width = 0.2), alpha = 0.3) +
  geom_smooth(se = F, method = lm) +
  labs(size = "Weight", y = 'AE', x = 'latitude')
```

```{r}
# ggplot(filter(dat, !is.na(habitat_d1)),
#        aes(x = mean_ann_temp, y = E_comb, color = habitat_d1)) +
#   geom_point(aes(size = 1/se_comb), position = position_jitter(width = 0.2), alpha = 0.3) +
#   geom_smooth(se = F, method = lm) +
#   labs(size = "Weight")
```

However, adding this interaction to the model is not an improvement. 

```{r}
mod8.2 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen*global + lat_abs_cen*habitat_d1,
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```
```{r}
cat("Delta DIC, habitat main vs habitat x latitude interaction (higher is better):\t", 
    mod8$DIC - mod8.2$DIC,
    sep = "")
```

Now we have tested all the environmental variables. To summarize, AE tends to be higher with low mean locale temperatures and in terrestrial habitats. 

### Host-parasite characteristics

Now, we turn to variables describing the host-parasite interaction. I consider a few: (1) host type, (2) stage in or out of host, and (3) target host. Compared to the environmental variables, these variables are not as obviously confounded with each other.

#### Plant vs animal parasite

A major dichotomy is between between plant and animal parasites. This might be relevant if plant and animal hosts have different activation energies or if they differ in how much they 'protect' parasites from temperature variation.

```{r}
mod9 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen*global + habitat_d1 +
                   plant_anim_parasite,
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```

Plant parasites have lower AE than animal parasites, but the contrast is not significant. Also, I imagine this distinction is strongly conflated with phylogeny.

```{r}
summary(mod9)
```

Adding the plant vs animal distinction was not an improvement

```{r}
cat("Delta DIC, add plant vs animal parasite distinction (higher is better):\t", 
    mod8$DIC - mod9$DIC,
    sep = "")
```

Here's the plot comparing plant and animal parasites.

```{r}
ggplot(dat, aes(x = plant_anim_parasite, y = E_comb)) +
  geom_boxplot(outlier.size = NULL, outlier.alpha = 0) +
  geom_point(aes(size = 1/se_comb), position = position_jitter(width = 0.2), alpha = 0.3) +
  labs(x = NULL, y = "Activation energy", size = "Weight")
```


#### Endotherm in life cycle

Besides the plant - animal distinction, parasites can be distinguished by whether or not they have an endotherm (a bird or mammal) in the life cycle. Since endotherm body temperatures are commonly higher than ambient temperatures, we might expect AE to differ between species with or without such a host in the life cycle.

This variable basically retains the previous plant-animal dichotomy, but it additionally splits animal parasites into two groups.

```{r}
table(dat$endotherm_in_cycle, dat$plant_anim_parasite)
```

We can thus combine these into a single variable to add to the model.

```{r}
dat <- dat%>%mutate(endo_ecto2 = if_else(plant_anim_parasite == "plant", "plant", endotherm_in_cycle))
```
```{r}
mod10 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen*global + habitat_d1 +
                    endo_ecto2,
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```

The term contrasting animal parasites with and without endotherms in the cycle was not significant. 

```{r}
summary(mod10)
```

But the model DIC was a little better.

```{r}
cat("Delta DIC, endotherm vs ectotherm host distinction (higher is better):\t", 
    mod9$DIC - mod10$DIC,
    sep = "")
```

Here is the plot comparing species with and without endotherms in their life cycles. There is very little difference.

```{r}
ggplot(dat, aes(x = endo_ecto2, y = E_comb)) +
  geom_boxplot(outlier.size = NULL, outlier.alpha = 0) +
  geom_point(aes(size = 1/se_comb), position = position_jitter(width = 0.2), alpha = 0.3) +
  labs(x = NULL, y = "Activation energy", size = "Weight")
```

#### Stage in or out of host?

Stages inside a host may be more shielded from temperature variation than stages in the environment. Let's add the distinction between stages in and out of the host to the model.

```{r}
mod11.1 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen*global + habitat_d1 +
                      endo_ecto2 + stage_in_out_host,
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```

This term was not significant...

```{r}
summary(mod11.1)
```

...and the model was not improved as judged by DIC.

```{r}
cat("Delta DIC, add stage in vs out of host distinction (higher is better):\t", 
    mod10$DIC - mod11.1$DIC,
    sep = "")
```

Here is the plot.

```{r}
ggplot(dat, aes(x = endo_ecto2, y = E_comb, color = stage_in_out_host)) +
  geom_boxplot(outlier.size = NULL, outlier.alpha = 0) +
  geom_point(aes(size = 1/se_comb), position = position_jitterdodge(jitter.width = 0.2), alpha = 0.3) +
  # facet_wrap(~trait_type, scales = 'free_x') +
  labs(x = NULL, y = "Activation energy", size = "Weight")
```

#### Target host

Stages free in the environment are generally propagules that target the next host in the life cycle. Are the parasites targeting a vertebrate or an invertebrate? It is not obvious to me that this should matter. But nonetheless, we can check it. 

```{r}
mod12 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen*global + habitat_d1 +
                    endo_ecto2 + target_host,
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```

Distinguishing between invertebrates and vertebrates as next host does not improve the model.

```{r}
cat("Delta DIC, distinguish target hosts of free propagules (higher is better):\t", 
    mod11.1$DIC - mod12$DIC,
    sep = "")
```

Here's the plot:

```{r}
ggplot(dat, aes(x = target_host, y = E_comb, color = stage_in_out_host)) +
  geom_boxplot(outlier.size = NULL, outlier.alpha = 0) +
  geom_point(aes(size = 1/se_comb), position = position_jitter(width = 0.25, height = 0), alpha = 0.2)+
  coord_flip() +
  labs(x = "Activation energy", y = NULL, color = NULL, size = "Weight")
```

# Revisit taxonomic effects

Now that we have added numerous predictors to the model, let's revisit our random effects, specifically phylogeny. The variation attributed to phylogeny may change as we account for some of the differences among parasite species that are likely phylogenetically structured (such as being aquatic or terrestrial). I refit the most complex model but with 3 different random effects: (i) with just a within-species effect, (ii) with just a phylogenetic effect, and (iii) with taxonomic levels.

```{r}
mod11_phyonly <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen*global + habitat_d1 +
                      endo_ecto2 + stage_in_out_host, 
                 random = ~ tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior1,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod11_spponly <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen*global + habitat_d1 +
                      endo_ecto2 + stage_in_out_host, 
                 random = ~ binomial + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat, prior = prior1,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod11_tax <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen*global + habitat_d1 +
                      endo_ecto2 + stage_in_out_host, 
                 random = ~ binomial + genus + fam + order + class + phylum +
                   idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat, 
                 prior = prior_tax,
                 nitt=iter, thin = 50,
                 family = "gaussian", pr=F, verbose = F)
```

After fitting those model, we compare the estimated variance explained by the random effects, i.e. the proportion of the residual variance explained after accounting for fixed effects. The pattern is fairly similar to what we saw above when we looked at phylogenetic effects without any fixed effects. Specifically, phylogeny explains more variation than the within-species effect alone, and the taxonomic model suggested that the 'family' term explained the most variation. 

```{r}

tax_eff <- rbind(
  quantile(mod11_tax$VCV[,1]/(rowSums(mod11_tax$VCV[,1:8])-1), probs = c(0.025, 0.5, 0.975)),
  quantile(mod11_tax$VCV[,2]/(rowSums(mod11_tax$VCV[,1:8])-1), probs = c(0.025, 0.5, 0.975)),
  quantile(mod11_tax$VCV[,3]/(rowSums(mod11_tax$VCV[,1:8])-1), probs = c(0.025, 0.5, 0.975)),
  quantile(mod11_tax$VCV[,4]/(rowSums(mod11_tax$VCV[,1:8])-1), probs = c(0.025, 0.5, 0.975)),
  quantile(mod11_tax$VCV[,5]/(rowSums(mod11_tax$VCV[,1:8])-1), probs = c(0.025, 0.5, 0.975)),
  quantile(mod11_tax$VCV[,6]/(rowSums(mod11_tax$VCV[,1:8])-1), probs = c(0.025, 0.5, 0.975)),
  quantile(rowSums(mod11_tax$VCV[,1:6])/(rowSums(mod11_tax$VCV[,1:8])-1), probs = c(0.025, 0.5, 0.975)),
  quantile(mod11.1$VCV[,'binomial']/(rowSums(mod11.1$VCV)-1), probs = c(0.025, 0.5, 0.975)),
  quantile(mod11.1$VCV[,'tree_tips']/(rowSums(mod11.1$VCV)-1), probs = c(0.025, 0.5, 0.975)),
  quantile(rowSums(mod11.1$VCV[,1:2])/(rowSums(mod11.1$VCV)-1), probs = c(0.025, 0.5, 0.975)),
  quantile(mod11_phyonly$VCV[,'tree_tips']/(rowSums(mod11_phyonly$VCV)-1), probs = c(0.025, 0.5, 0.975)),
  quantile(mod11_spponly$VCV[,'binomial']/(rowSums(mod11_spponly$VCV)-1), probs = c(0.025, 0.5, 0.975))

)

tax_eff <- data.frame(tax_eff)
names(tax_eff) <- c('vc.lwr', 'vc.fit', 'vc.upr')
tax_eff$t_level <- c('species', 'genus', 'family', 'order', 'class', 'phylum', 'total',
                     'species', 'tree', 'total', 'total', 'total')
tax_eff <- mutate(tax_eff, 
                  t_level = factor(t_level, levels = c('species', 'genus', 'family', 'order', 'class', 'phylum', 'tree', 'total')),
                  model = c(rep('taxonomy', times = 7), rep('phylogeny+w/in spp', times = 3), 
                            'phylo only', 'w/in spp\nonly'))%>%
  mutate(model = factor(model, levels = c('w/in spp\nonly', 'phylo only', 'phylogeny+w/in spp', 'taxonomy' )))

ggplot(tax_eff, aes(x = t_level, y = vc.fit)) +
  geom_pointrange(aes(ymin = vc.lwr, ymax = vc.upr, color = t_level == 'total')) +
  labs(x = NULL, 
       y = 'Proportion of variance in AE explained') +
  guides(color = FALSE) +
  facet_grid(~model, scales = 'free_x', space = 'free_x') +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank())
```

# Summary

In this analysis of activation energies in helminths, I account for measurement variance (standard error of activation energy estimates) and I account for two sources of pseudoreplication: multiple measurements on a single parasite species and shared ancestry. Next, I evaluated various environmental characteristics. Then, I assessed characteristics of the host-parasite interaction.

Finally, let's quantitatively summarize the results. For each of the fitted models, I compiled the df, the DIC, and the R^2^. I calculated R^2^ according to [Nakagawa and Schielzeth (2013)](https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/j.2041-210x.2012.00261.x%4010.1111/%28ISSN%292041-210X.STATSTOO). They distinguish between marginal and conditional R^2^. Marginal R^2^ is the proportion of variation explained by the fixed effects while conditional R^2^ is the variation explained by both fixed and random effects. The difference between marginal and conditional R^2^ therefore represents the variance explained by random effects (mainly phylogeny in our case). In the following table, terms followed by asterisks were retained in the model.  

```{r}
# the series of models fit
mod_series <- c("intercept-only", "+ within species*", "+ phylogeny*", "+ metric (min, mid, max)",
                "+ mean annual temp*", "+ temp x locale", "+ min/max temps", 
                "+ latitude*", "+ distribution zone", "+ latitude x global dist*",
                "+ habitat (aquatic vs terrestrial)*", "+ habitat x latitude interacton",
                "+ plant vs animal parasite*", "+ endotherm in life cycle?*",
                "+ stage in/out of host*", "+ target host: invert vs vert")
```
```{r}
# loop through models, collect DIC and df
i <- 0
if(exists("mod_dic")){rm(mod_dic)}
if(exists("mod_df")){rm(mod_df)}
for(m in list(mod00, mod0, mod1, mod3, 
              mod4, mod4.2, mod5, 
              mod6, mod7, mod7.2,
              mod8, mod8.2,
              mod9, mod10,
              mod11.1, mod12)){
  if(i == 0){
    mod_dic <- m$DIC
    mod_df <- m$Fixed$nfl + length(m$Random$nrt)-1 # remove 1 df for weights (it is fixed)
  } else {
    mod_dic <- c(mod_dic, m$DIC)
    mod_df <- c(mod_df, m$Fixed$nfl + length(m$Random$nrt)-1)
  }
  i <- i + 1
}
```
```{r}
# loop through models, calculate R2
i <- 0
if(exists("r2c")){rm(r2c)}
if(exists("r2m")){rm(r2m)}

for(m in list(mod00, mod0, mod1, mod3, 
              mod4, mod4.2, mod5, 
              mod6, mod7, mod7.2,
              mod8, mod8.2,
              mod9, mod10,
              mod11.1, mod12)){

  # calculate fixed effects var
  fixVar <- numeric(length(m$Sol[,1]))
  for(j in 1:length(m$Sol[,1])){
    fixVar_j <- var(as.vector(m$Sol[j,] %*% t(m$X)))
    fixVar[j] <- fixVar_j
  }
  
  # random effects var
  resi <- which(colnames(m$VCV) %in% c('units')) # remove resid variance from variance components
  randVar <- m$VCV[,-resi]
  if(!is.null(colnames(randVar))){ # if only one random effect, it is unnamed and can't use rowSums
    randVar <- rowSums(randVar)-1
    }
  
  # resid var
  resVar <- m$VCV[,'units']
  
  # calculate R2
  r2m <- (fixVar)/(fixVar + randVar + resVar)
  r2c <- (fixVar + randVar)/(fixVar + randVar + resVar)
  
  # for output...
  r2m_oi <- paste0(round(median(r2m),3), ' [', 
         round(quantile(r2m, probs = 0.025), 2), '-', 
         round(quantile(r2m, probs = 0.975), 2), ']')
  r2c_oi <- paste0(round(median(r2c),3), ' [', 
         round(quantile(r2c, probs = 0.025), 2), '-', 
         round(quantile(r2c, probs = 0.975), 2), ']')
  
  if(i == 0){
    r2m_o <- "0 [0-0]" #posterior.mode(r2m)
    r2c_o <- "0 [0-0]" #posterior.mode(r2c)
  } else {
    r2m_o <- c(r2m_o, r2m_oi)
    r2c_o <- c(r2c_o, r2c_oi)
  }
  i <- i + 1
}
```
```{r}
end_tbl <- data.frame(model = mod_series, df = mod_df)
end_tbl <- mutate(end_tbl, df_used = df - lag(df, 1))
end_tbl$DIC <- round(mod_dic, 2)
end_tbl$R2m <- r2m_o
end_tbl$R2c <- r2c_o
```
```{r}
knitr::kable(end_tbl)
```

Let's try to list the important results:

1. Phylogeny explains considerable variation in AE. Some, but not all, of this is due to some species being measured multiple times.
2. Parasites from locales with lower mean temperatures had higher AE.
3. Terrestrial parasites have higher AE than aquatic parasites.
4. Individually, none of the parasite characteristics were significant. But in combination, they explain about 5% of the variation in AE. Trends were for higher AE in animal parasites and external life stages. 

Overall, the most complex model, one that includes phylogeny, seemingly important environmental variables, and characteristics of the host-parasite system, explained ~80% of the variation in activation energy. Much of this is due to the random effects (phylogeny and repeated measures account for >60% of the variation), but around 20% of the variation can be explained by fixed effects.

# Robustness to dropping SS fits

Since we were concerned about mixing AE estimated by Arrhenius with those estimated by SS, let's drop the ones estimated by SS and then recompute the R^2^ table. Does it look more or less the same? It does with perhaps a few minor differences.

```{r}
mod00 <- MCMCglmm(E_comb ~ 1, # intercept only, SE weighted
                  random = ~ idh(se_comb):units,
                  data = filter(dat, best_mod2 != 'SS'),
                  prior = list(G=list(G1=list(V=1,fix=1)),R=list(V=1,nu=0.002)), # fix prior for SE weights
                  nitt=13000, thin = 10,
                  family = "gaussian", pr=F, verbose = F)
mod0 <- MCMCglmm(E_comb ~ 1, 
                 random = ~ binomial + idh(se_comb):units, # w/in spp effx
                 data = filter(dat, best_mod2 != 'SS'),
                 prior = prior1,
                 nitt=13000, thin = 10,
                 family = "gaussian", pr=F, verbose = F)
mod1 <- MCMCglmm(E_comb ~ 1, 
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = filter(dat, best_mod2 != 'SS'), 
                 prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod3 <- MCMCglmm(E_comb ~ simplified_metric, 
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = filter(dat, best_mod2 != 'SS'), prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod4 <- MCMCglmm(E_comb ~ mean_ann_temp_cen, 
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = filter(dat, best_mod2 != 'SS'), prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod4.2 <- MCMCglmm(E_comb ~ mean_ann_temp_cen*sampling_location_available, 
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = filter(dat, best_mod2 != 'SS'), prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod5 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + 
                   max_month_temp_cen + min_month_temp_cen, 
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = filter(dat, best_mod2 != 'SS'), prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod6 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen,
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = filter(dat, best_mod2 != 'SS'), prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod7 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + dist_zone,
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = filter(dat, best_mod2 != 'SS'), prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod7.2 <- MCMCglmm(E_comb ~  mean_ann_temp_cen + lat_abs_cen*global,
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = filter(dat, best_mod2 != 'SS'), prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod8 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen*global + habitat_d1,
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = filter(dat, best_mod2 != 'SS'), prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod8.2 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen*global + lat_abs_cen*habitat_d1,
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = filter(dat, best_mod2 != 'SS'), prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod9 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen*global + habitat_d1 +
                   plant_anim_parasite,
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = filter(dat, best_mod2 != 'SS'), prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod10 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen*global + habitat_d1 +
                    endo_ecto2,
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = filter(dat, best_mod2 != 'SS'), prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod11.1 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen*global + habitat_d1 +
                      endo_ecto2 + stage_in_out_host,
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = filter(dat, best_mod2 != 'SS'), prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod12 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen*global + habitat_d1 +
                    endo_ecto2 + target_host,
                 random = ~ binomial + tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = filter(dat, best_mod2 != 'SS'), prior = prior2,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```
```{r}
# the series of models fit
mod_series <- c("intercept-only", "+ within species*", "+ phylogeny*", "+ metric (min, mid, max)",
                "+ mean annual temp*", "+ temp x locale", "+ min/max temps", 
                "+ latitude*", "+ distribution zone", "+ latitude x global dist*",
                "+ habitat (aquatic vs terrestrial)*", "+ habitat x latitude interacton",
                "+ plant vs animal parasite*", "+ endotherm in life cycle?*",
                "+ stage in/out of host*", "+ target host: invert vs vert")
```
```{r}
# loop through models, collect DIC and df
i <- 0
if(exists("mod_dic")){rm(mod_dic)}
if(exists("mod_df")){rm(mod_df)}
for(m in list(mod00, mod0, mod1, mod3, 
              mod4, mod4.2, mod5, 
              mod6, mod7, mod7.2,
              mod8, mod8.2,
              mod9, mod10,
              mod11.1, mod12)){
  if(i == 0){
    mod_dic <- m$DIC
    mod_df <- m$Fixed$nfl + length(m$Random$nrt)-1 # remove 1 df for weights (it is fixed)
  } else {
    mod_dic <- c(mod_dic, m$DIC)
    mod_df <- c(mod_df, m$Fixed$nfl + length(m$Random$nrt)-1)
  }
  i <- i + 1
}
```
```{r}
# loop through models, calculate R2
i <- 0
if(exists("r2c")){rm(r2c)}
if(exists("r2m")){rm(r2m)}

for(m in list(mod00, mod0, mod1, mod3, 
              mod4, mod4.2, mod5, 
              mod6, mod7, mod7.2,
              mod8, mod8.2,
              mod9, mod10,
              mod11.1, mod12)){

  # calculate fixed effects var
  fixVar <- numeric(length(m$Sol[,1]))
  for(j in 1:length(m$Sol[,1])){
    fixVar_j <- var(as.vector(m$Sol[j,] %*% t(m$X)))
    fixVar[j] <- fixVar_j
  }
  
  # random effects var
  resi <- which(colnames(m$VCV) %in% c('units')) # remove resid variance from variance components
  randVar <- m$VCV[,-resi]
  if(!is.null(colnames(randVar))){ # if only one random effect, it is unnamed and can't use rowSums
    randVar <- rowSums(randVar)-1
    }
  
  # resid var
  resVar <- m$VCV[,'units']
  
  # calculate R2
  r2m <- (fixVar)/(fixVar + randVar + resVar)
  r2c <- (fixVar + randVar)/(fixVar + randVar + resVar)
  
  # for output...
  r2m_oi <- paste0(round(median(r2m),3), ' [', 
         round(quantile(r2m, probs = 0.025), 2), '-', 
         round(quantile(r2m, probs = 0.975), 2), ']')
  r2c_oi <- paste0(round(median(r2c),3), ' [', 
         round(quantile(r2c, probs = 0.025), 2), '-', 
         round(quantile(r2c, probs = 0.975), 2), ']')
  
  if(i == 0){
    r2m_o <- "0 [0-0]" #posterior.mode(r2m)
    r2c_o <- "0 [0-0]" #posterior.mode(r2c)
  } else {
    r2m_o <- c(r2m_o, r2m_oi)
    r2c_o <- c(r2c_o, r2c_oi)
  }
  i <- i + 1
}
```
```{r}
end_tbl <- data.frame(model = mod_series, df = mod_df)
end_tbl <- mutate(end_tbl, df_used = df - lag(df, 1))
end_tbl$DIC <- round(mod_dic, 2)
end_tbl$R2m <- r2m_o
end_tbl$R2c <- r2c_o
```
```{r}
knitr::kable(end_tbl)
```

One difference is that the temperature effect is clearer when the SS fits are excluded. A few of the SS curves yielded high AEs for parasites from warm locales, which went against the overall trend.

```{r}
ggplot(dat, aes(x = mean_ann_temp, y = E_comb, color = best_mod2)) +
  geom_point(alpha = 0.5, aes(size = 1/se_comb)) +
  labs(color = "best model, strict", size = "Weight, 1/SE", y = 'Activation energy') +
  geom_smooth(method = lm, se = F) 
```

A smaller effect might be for the distinction between animal parasites with and without endotherms in their life cycles; the improvement in DIC was a bit larger for this term without the SS curves. However, the SS curves are not obvious outliers with regard to this variable, though they may reduce the difference between species with and without endotherms in the life cycle.

```{r}
ggplot(filter(dat),
       aes(x = endo_ecto2, y = E_comb)) +
  geom_boxplot(outlier.colour = NA) +
  geom_point(aes(size = 1/se_comb, color = best_mod2),
             position = position_jitter(width = 0.2), alpha = 0.3) +
  # facet_wrap(~trait_type) +
  labs(size = "Weight", y = "Activation Energy", x = NULL)
```

Overall, the SS curves do not have an obvious affect on the results. When we look at the terms from the most complex model, the same ones (temp and habitat) are considered significant. Thus, I do not see a good reason to exclude the SS fits.

```{r}
summary(mod12)$solutions
```

# Robustness to pseudoreplication

The phylogenetic and taxonomic analyses above suggest that species measured multiple times tend to yield consistent AEs. While the mixed models account for this, let's nonetheless fit the models to just a single AE per species and check how it affects the results. I take the "best" curve for each species, which I define as the AE estimate with the lowest standard error. 

```{r}
sp_se <- group_by(dat, binomial)%>%
  summarize(min_se = min(se_comb))

dat_1per_sp <- dat%>%
  mutate(match = paste(binomial, se_comb))%>%
  filter(match %in% paste(sp_se$binomial, sp_se$min_se))%>%
  select(-match)
```

This reduces the sample size quite a bit from `r length(dat$binomial)` to `r length(dat_1per_sp$binomial)`. This is probably too aggressive, because we are tossing AE values that are at least somewhat independent, such as different life stages from the same species. Nonetheless, here's the R^2^ table. It is rather similar.

```{r}
mod00 <- MCMCglmm(E_comb ~ 1, # intercept only, SE weighted
                  random = ~ idh(se_comb):units,
                  data = dat_1per_sp,
                  prior = list(G=list(G1=list(V=1,fix=1)),R=list(V=1,nu=0.002)), # fix prior for SE weights
                  nitt=13000, thin = 10,
                  family = "gaussian", pr=F, verbose = F)
mod1 <- MCMCglmm(E_comb ~ 1, 
                 random = ~ tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat_1per_sp, 
                 prior = prior1,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod3 <- MCMCglmm(E_comb ~ simplified_metric, 
                 random = ~ tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat_1per_sp, prior = prior1,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod4 <- MCMCglmm(E_comb ~ mean_ann_temp_cen, 
                 random = ~ tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat_1per_sp, prior = prior1,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod4.2 <- MCMCglmm(E_comb ~ mean_ann_temp_cen*sampling_location_available, 
                 random = ~ tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat_1per_sp, prior = prior1,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod5 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + 
                   max_month_temp_cen + min_month_temp_cen, 
                 random = ~ tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat_1per_sp, prior = prior1,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod6 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen,
                 random = ~ tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat_1per_sp, prior = prior1,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod7 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + dist_zone,
                 random = ~ tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat_1per_sp, prior = prior1,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod7.2 <- MCMCglmm(E_comb ~  mean_ann_temp_cen + lat_abs_cen*global,
                 random = ~ tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat_1per_sp, prior = prior1,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod8 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen*global + habitat_d1,
                 random = ~ tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat_1per_sp, prior = prior1,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod8.2 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen*global + lat_abs_cen*habitat_d1,
                 random = ~ tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat_1per_sp, prior = prior1,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod9 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen*global + habitat_d1 +
                   plant_anim_parasite,
                 random = ~ tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat_1per_sp, prior = prior1,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod10 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen*global + habitat_d1 +
                    endo_ecto2,
                 random = ~ tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat_1per_sp, prior = prior1,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod11.1 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen*global + habitat_d1 +
                      endo_ecto2 + stage_in_out_host,
                 random = ~ tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat_1per_sp, prior = prior1,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
mod12 <- MCMCglmm(E_comb ~ mean_ann_temp_cen + lat_abs_cen*global + habitat_d1 +
                    endo_ecto2 + target_host,
                 random = ~ tree_tips + idh(se_comb):units, # w/in spp + phylogenetic effx
                 data = dat_1per_sp, prior = prior1,
                 nitt=iter, thin = 50,
                 ginverse = list(tree_tips=Ainv),
                 family = "gaussian", pr=F, verbose = F)
```
```{r}
# the series of models fit
mod_series <- c("intercept-only", "+ phylogeny*", "+ metric (min, mid, max)",
                "+ mean annual temp*", "+ temp x locale", "+ min/max temps", 
                "+ latitude*", "+ distribution zone", "+ latitude x global dist*",
                "+ habitat (aquatic vs terrestrial)*", "+ habitat x latitude interacton",
                "+ plant vs animal parasite*", "+ endotherm in life cycle?*",
                "+ stage in/out of host*", "+ target host: invert vs vert")
```
```{r}
# loop through models, collect DIC and df
i <- 0
if(exists("mod_dic")){rm(mod_dic)}
if(exists("mod_df")){rm(mod_df)}
for(m in list(mod00, mod1, mod3, 
              mod4, mod4.2, mod5, 
              mod6, mod7, mod7.2,
              mod8, mod8.2,
              mod9, mod10,
              mod11.1, mod12)){
  if(i == 0){
    mod_dic <- m$DIC
    mod_df <- m$Fixed$nfl + length(m$Random$nrt)-1 # remove 1 df for weights (it is fixed)
  } else {
    mod_dic <- c(mod_dic, m$DIC)
    mod_df <- c(mod_df, m$Fixed$nfl + length(m$Random$nrt)-1)
  }
  i <- i + 1
}
```
```{r}
# loop through models, calculate R2
i <- 0
if(exists("r2c")){rm(r2c)}
if(exists("r2m")){rm(r2m)}

for(m in list(mod00, mod1, mod3, 
              mod4, mod4.2, mod5, 
              mod6, mod7, mod7.2,
              mod8, mod8.2,
              mod9, mod10,
              mod11.1, mod12)){

  # calculate fixed effects var
  fixVar <- numeric(length(m$Sol[,1]))
  for(j in 1:length(m$Sol[,1])){
    fixVar_j <- var(as.vector(m$Sol[j,] %*% t(m$X)))
    fixVar[j] <- fixVar_j
  }
  
  # random effects var
  resi <- which(colnames(m$VCV) %in% c('units')) # remove resid variance from variance components
  randVar <- m$VCV[,-resi]
  if(!is.null(colnames(randVar))){ # if only one random effect, it is unnamed and can't use rowSums
    randVar <- rowSums(randVar)-1
    }
  
  # resid var
  resVar <- m$VCV[,'units']
  
  # calculate R2
  r2m <- (fixVar)/(fixVar + randVar + resVar)
  r2c <- (fixVar + randVar)/(fixVar + randVar + resVar)
  
  # for output...
  r2m_oi <- paste0(round(median(r2m),3), ' [', 
         round(quantile(r2m, probs = 0.025), 2), '-', 
         round(quantile(r2m, probs = 0.975), 2), ']')
  r2c_oi <- paste0(round(median(r2c),3), ' [', 
         round(quantile(r2c, probs = 0.025), 2), '-', 
         round(quantile(r2c, probs = 0.975), 2), ']')
  
  if(i == 0){
    r2m_o <- "0 [0-0]" #posterior.mode(r2m)
    r2c_o <- "0 [0-0]" #posterior.mode(r2c)
  } else {
    r2m_o <- c(r2m_o, r2m_oi)
    r2c_o <- c(r2c_o, r2c_oi)
  }
  i <- i + 1
}
```
```{r}
end_tbl <- data.frame(model = mod_series, df = mod_df)
end_tbl <- mutate(end_tbl, df_used = df - lag(df, 1))
end_tbl$DIC <- round(mod_dic, 2)
end_tbl$R2m <- r2m_o
end_tbl$R2c <- r2c_o
```
```{r}
knitr::kable(end_tbl)
```

There is still a phylogenetic effect and the same terms (temp and habitat) are considered significant.

```{r}
summary(mod12)$solutions
```

# Conclusions

Related parasites tend to exhibit similar AE. Species from colder locations have higher AE. Terrestrial species have higher AE than aquatic species. These results are robust to including/excluding Sharp-Schoolfield fits and to only using a single AE estimate per species.